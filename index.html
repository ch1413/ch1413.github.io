<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨å›½å…¬å•æ™ºèƒ½å¯¼èˆªç³»ç»Ÿ</title>
    <script type="text/javascript">
        window._AMapSecurityConfig = {
            securityJsCode: "99e3954b4b466ebbbe24118338ef6c91",
        };
    </script>
    <!-- ä½¿ç”¨é«˜å¾·åœ°å›¾API v2.0 ä¿®å¤500é”™è¯¯ -->
    <script
        src="https://webapi.amap.com/maps?v=2.0&key=3da096629cc77da916196115d45f9d63&plugin=AMap.ToolBar,AMap.Scale,AMap.HeatMap,AMap.Driving"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft YaHei", sans-serif;
        }

        body,
        html {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        /* ç³»ç»Ÿå¤´éƒ¨ */
        .system-header {
            height: 60px;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 1000;
        }

        .system-title {
            font-size: 20px;
            font-weight: bold;
            color: #2c3e50;
            display: flex;
            align-items: center;
        }

        .system-title i {
            margin-right: 10px;
            font-size: 24px;
            color: #3498db;
        }

        .system-version {
            font-size: 14px;
            color: #7f8c8d;
            background: #f8f9fa;
            padding: 5px 15px;
            border-radius: 20px;
        }

        /* åœ°å›¾å®¹å™¨ - ä¿®å¤Canvasæ€§èƒ½è­¦å‘Š */
        #mapContainer {
            width: 100%;
            height: calc(100vh - 60px);
            position: relative;
        }

        /* å·¦ä¾§æ§åˆ¶é¢æ¿ */
        .left-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 320px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
            z-index: 100;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
        }

        /* å³ä¾§å¯¼èˆªé¢æ¿ */
        .right-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 300px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
            z-index: 100;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
        }

        .panel-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .panel-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .section-title {
            font-size: 16px;
            color: #2c3e50;
            margin-bottom: 15px;
            font-weight: 600;
            display: flex;
            align-items: center;
        }

        .section-title i {
            margin-right: 8px;
            color: #3498db;
        }

        /* è¾“å…¥æ¡†å’Œé€‰æ‹©å™¨æ ·å¼ */
        .input-group {
            margin-bottom: 15px;
        }

        .input-label {
            display: block;
            font-size: 13px;
            color: #3498db;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .input-field,
        .select-field {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e0e6ed;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
            background: #f8fafc;
        }

        .input-field:focus,
        .select-field:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 10px 0;
        }

        /* çƒ­åŠ›å›¾æ§åˆ¶æŒ‰é’®ç»„ - æ–°å¢ */
        .heatmap-controls {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            margin-top: 10px;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #2980b9, #2573a7);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #8e44ad, #7d3c98);
            transform: translateY(-1px);
        }

        .btn-success {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #27ae60, #219653);
            transform: translateY(-1px);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        /* çƒ­åŠ›å›¾æ§åˆ¶æŒ‰é’®æ ·å¼ - æ–°å¢ */
        .btn-heatmap {
            background: linear-gradient(135deg, #e67e22, #d35400);
            color: white;
            font-size: 13px;
            padding: 8px 5px;
        }

        .btn-heatmap:hover {
            background: linear-gradient(135deg, #d35400, #c0392b);
            transform: translateY(-1px);
        }

        /* çŠ¶æ€æ˜¾ç¤º */
        .status-panel {
            margin-top: 15px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            font-size: 13px;
            color: #2c3e50;
        }

        /* å¯¼èˆªä¿¡æ¯é¢æ¿ */
        .navigation-info {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .nav-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .nav-value {
            font-weight: 600;
            color: #2c3e50;
        }

        .nav-distance {
            color: #e74c3c;
            font-size: 18px;
            font-weight: bold;
        }

        .nav-time {
            color: #3498db;
            font-size: 16px;
            font-weight: bold;
        }

        /* çƒ­åŠ›å›¾å›¾ä¾‹ - æ–°å¢ */
        .heatmap-legend {
            position: absolute;
            bottom: 80px;
            left: 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            padding: 10px 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 100;
            display: none;
        }

        .legend-title {
            font-size: 12px;
            color: #2c3e50;
            margin-bottom: 8px;
            font-weight: 600;
            text-align: center;
        }

        .legend-gradient {
            width: 200px;
            height: 20px;
            background: linear-gradient(to right, rgba(128, 0, 128, 0.7), rgba(255, 0, 0, 0.8), rgba(255, 165, 0, 0.9), rgba(255, 255, 0, 1), rgba(255, 255, 255, 1));
            border-radius: 4px;
            margin-bottom: 5px;
        }

        .legend-labels {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #7f8c8d;
        }

        .nav-character {
            width: 40px;
            height: 40px;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="30" r="20" fill="%23ff6b6b"/><path d="M30,70 Q50,90 70,70 L50,50 Z" fill="%234ecdc4"/><circle cx="40" cy="25" r="5" fill="white"/><circle cx="60" cy="25" r="5" fill="white"/><path d="M45,35 Q50,40 55,35" stroke="white" stroke-width="3" fill="none"/></svg>') no-repeat center;
            background-size: contain;
            border-radius: 50%;
            transition: transform 0.1s linear;
            z-index: 1000;
            pointer-events: none;
        }

        .nav-progress {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            max-width: 600px;
            height: 8px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            z-index: 1000;
            overflow: hidden;
        }

        .nav-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            width: 0%;
            transition: width 0.3s linear;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1200px) {
            .right-panel {
                display: none;
            }

            .left-panel {
                width: 95%;
                left: 2.5%;
            }

            .heatmap-legend {
                width: 90%;
                left: 5%;
            }
        }
    </style>
</head>

<body>
    <!-- ç³»ç»Ÿå¤´éƒ¨ -->
    <div class="system-header">
        <div class="system-title">
            <<i>ğŸš½</< /i>
                å…¨å›½å…¬å•æ™ºèƒ½å¯¼èˆªç³»ç»Ÿ
        </div>
        <div class="system-version">
            v2.2 - ä¿®å¤çƒ­åŠ›å›¾&å¯¼èˆªåŠ¨ç”»
        </div>
    </div>

    <!-- åœ°å›¾å®¹å™¨ -->
    <div id="mapContainer"></div>

    <!-- å¯¼èˆªè¿›åº¦æ¡ -->
    <div class="nav-progress" id="navProgress" style="display: none;">
        <div class="nav-progress-bar" id="navProgressBar"></div>
    </div>

    <!-- çƒ­åŠ›å›¾å›¾ä¾‹ - æ–°å¢ -->
    <div class="heatmap-legend" id="heatmapLegend">
        <div class="legend-title">å…¬å•çƒ­åº¦åˆ†å¸ƒ</div>
        <div class="legend-gradient"></div>
        <div class="legend-labels">
            <span>ä½çƒ­åº¦</span>
            <span>ä¸­çƒ­åº¦</span>
            <span>é«˜çƒ­åº¦</span>
        </div>
    </div>

    <!-- å·¦ä¾§æ§åˆ¶é¢æ¿ -->
    <div class="left-panel">
        <!-- åœ°å›¾æ¨¡å¼åˆ‡æ¢ -->
        <div class="panel-section">
            <div class="section-title">
                <<i>ğŸ—ºï¸</< /i>
                    åœ°å›¾æ¨¡å¼
            </div>
            <div class="btn-group">
                <button class="btn btn-primary" id="btnNormalMap">
                    <<i>ğŸŒ</< /i>
                        æ ‡å‡†åœ°å›¾
                </button>
                <button class="btn btn-secondary" id="btnSatellite">
                    <<i>ğŸ›°ï¸</< /i>
                        å«æ˜Ÿå½±åƒ
                </button>
                <button class="btn btn-warning" id="btnDarkHeatmap">
                    <<i>ğŸ”¥</i>
                        æ·±è‰²çƒ­åŠ›å›¾
                </button>
            </div>

            <!-- çƒ­åŠ›å›¾æ§åˆ¶æŒ‰é’®ç»„ - æ–°å¢ -->
            <div class="heatmap-controls">
                <button class="btn btn-heatmap" id="btnHeatmapSmall">
                    <<i>ğŸ”</i>
                        å°åŠå¾„
                </button>
                <button class="btn btn-heatmap" id="btnHeatmapMedium">
                    <<i>ğŸ”</i>
                        ä¸­åŠå¾„
                </button>
                <button class="btn btn-heatmap" id="btnHeatmapLarge">
                    <<i>ğŸ”</i>
                        å¤§åŠå¾„
                </button>
            </div>
        </div>

        <!-- ä½ç½®æœç´¢ -->
        <div class="panel-section">
            <div class="section-title">
                <<i>ğŸ“</< /i>
                    ä½ç½®æœç´¢
            </div>
            <div class="input-group">
                <label class="input-label">æœç´¢åŸå¸‚æˆ–åŒºåŸŸ</label>
                <input type="text" class="input-field" id="searchCity" placeholder="è¾“å…¥åŸå¸‚åç§°ï¼Œå¦‚ï¼šåŒ—äº¬ã€ä¸Šæµ·" value="åŒ—äº¬å¸‚">
            </div>
            <button class="btn btn-primary" id="btnSearchCity" style="width: 100%; margin-bottom: 10px;">
                <<i>ğŸ”</< /i>
                    æœç´¢åŒºåŸŸå…¬å•
            </button>
            <button class="btn btn-secondary" id="btnGetLocation" style="width: 100%;">
                <<i>ğŸ“</< /i>
                    è·å–å½“å‰ä½ç½®
            </button>
        </div>

        <!-- å…¬å•æ˜¾ç¤ºæ§åˆ¶ -->
        <div class="panel-section">
            <div class="section-title">
                <<i>ğŸš½</< /i>
                    å…¬å•æ˜¾ç¤º
            </div>
            <div class="btn-group">
                <button class="btn btn-primary" id="btnShowAll">
                    <<i>ğŸ </< /i>
                        æ˜¾ç¤ºå…¨éƒ¨
                </button>
                <button class="btn btn-danger" id="btnClearAll">
                    <<i>ğŸ—‘ï¸</< /i>
                        æ¸…ç©ºæ˜¾ç¤º
                </button>
            </div>
        </div>

        <!-- ç³»ç»ŸçŠ¶æ€ -->
        <div class="status-panel" id="systemStatus">
            ç³»ç»Ÿåˆå§‹åŒ–ä¸­...
        </div>
    </div>

    <!-- å³ä¾§ï¼šå¯¼èˆªæ§åˆ¶é¢æ¿ -->
    <div class="right-panel">
        <!-- å¯¼èˆªè®¾ç½® -->
        <div class="panel-section">
            <div class="section-title">
                <<i>ğŸ§­</< /i>
                    å¯¼èˆªè®¾ç½®
            </div>
            <div class="input-group">
                <label class="input-label">å½“å‰ä½ç½®</label>
                <input type="text" class="input-field" id="currentPosition" placeholder="ç‚¹å‡»åœ°å›¾æˆ–è‡ªåŠ¨è·å–" readonly>
            </div>
            <div class="input-group">
                <label class="input-label">ç›®æ ‡å…¬å•</label>
                <select class="select-field" id="selectToilet">
                    <option value="">è¯·é€‰æ‹©ç›®æ ‡å…¬å•</option>
                </select>
            </div>
            <div class="input-group">
                <label class="input-label">äº¤é€šå·¥å…·</label>
                <select class="select-field" id="transportMode">
                    <option value="walking">æ­¥è¡Œ</option>
                    <option value="driving" selected>é©¾è½¦</option>
                    <option value="bicycling">éª‘è¡Œ</option>
                    <option value="transit">å…¬äº¤</option>
                </select>
            </div>
            <button class="btn btn-success" id="btnStartNavigation" style="width: 100%;">
                <<i>ğŸš€</< /i>
                    å¼€å§‹å¯¼èˆª
            </button>
            <button class="btn btn-warning" id="btnPauseNavigation"
                style="width: 100%; margin-top: 10px; display: none;">
                <<i>â¸ï¸</< /i>
                    æš‚åœå¯¼èˆª
            </button>
        </div>

        <!-- å¯¼èˆªä¿¡æ¯ -->
        <div class="navigation-info" id="navInfo" style="display: none;">
            <div class="nav-item">
                <span>ç›®çš„åœ°ï¼š</span>
                <span class="nav-value" id="navDestination">-</span>
            </div>
            <div class="nav-item">
                <span>è·ç¦»ï¼š</span>
                <span class="nav-distance" id="navDistance">-</span>
            </div>
            <div class="nav-item">
                <span>é¢„è®¡æ—¶é—´ï¼š</span>
                <span class="nav-time" id="navTime">-</span>
            </div>
            <div class="nav-item">
                <span>äº¤é€šå·¥å…·ï¼š</span>
                <span class="nav-value" id="navTransport">-</span>
            </div>
            <button class="btn btn-danger" id="btnStopNav" style="width: 100%; margin-top: 10px;">
                <<i>â¹ï¸</< /i>
                    ç»“æŸå¯¼èˆª
            </button>
        </div>

        <!-- å…¬å•ç»Ÿè®¡ -->
        <div class="panel-section">
            <div class="section-title">
                <<i>ğŸ“Š</< /i>
                    å…¬å•ç»Ÿè®¡
            </div>
            <div class="status-panel">
                <div>å…¨å›½å…¬å•æ€»æ•°: <strong id="totalToilets">0</strong></div>
                <div>å½“å‰æ˜¾ç¤º: <strong id="displayedToilets">0</strong></div>
                <div>æ™®é€šå…¬å•: <span style="color:#3498db;" id="generalCount">0</span></div>
                <div>æ— éšœç¢: <span style="color:#e74c3c;" id="accessibleCount">0</span></div>
                <div>æ¯å©´å®¤: <span style="color:#9b59b6;" id="motherCount">0</span></div>
            </div>
        </div>
    </div>

    <script>
        // ============ ç³»ç»Ÿé…ç½® ============
        const CONFIG = {
            AMAP_KEY: '3da096629cc77da916196115d45f9d63', // æ›¿æ¢ä¸ºä½ çš„é«˜å¾·Webç«¯JS API Key
            DEFAULT_CENTER: [116.397428, 39.90923], // åŒ—äº¬ä¸­å¿ƒ
            DEFAULT_ZOOM: 5, // å…¨å›½è§†å›¾
            MAX_ZOOM: 16, // å«æ˜Ÿå›¾æœ€å¤§ç¼©æ”¾çº§åˆ«ï¼ˆé¿å…ç©ºç™½ï¼‰
            HEATMAP_OPTIONS: {
                radius: 20,  // çƒ­åŠ›å›¾é»˜è®¤åŠå¾„
                minRadius: 10, // æœ€å°åŠå¾„
                maxRadius: 30, // æœ€å¤§åŠå¾„
                opacity: [0, 0.9],
                gradient: {  // æ·±è‰²çƒ­åŠ›å›¾é…è‰²
                    0.0: 'rgba(0, 0, 0, 0)',
                    0.1: 'rgba(128, 0, 128, 0.7)',
                    0.3: 'rgba(255, 0, 0, 0.8)',
                    0.5: 'rgba(255, 165, 0, 0.9)',
                    0.7: 'rgba(255, 255, 0, 1)',
                    1.0: 'rgba(255, 255, 255, 1)'
                }
            },
            ANIMATION_SPEED: { // ä¸åŒäº¤é€šå·¥å…·çš„åŠ¨ç”»é€Ÿåº¦ï¼ˆåƒç´ /æ¯«ç§’ï¼‰
                walking: 0.5,
                driving: 2,
                bicycling: 1,
                transit: 1.5
            }
        };

        // ============ å…¨å›½å…¬å•æ•°æ®ï¼ˆæ¥æºï¼šé«˜å¾·POIæ£€ç´¢ï¼‰ ============
        // è¿è¡Œæ—¶é€šè¿‡é«˜å¾·POIæ£€ç´¢å¡«å……ï¼Œé¿å…ä½¿ç”¨æœ¬åœ°é™æ€æ•°æ®
        const NATIONAL_TOILET_DATA = [];

        // ============ å…¨å±€å˜é‡ ============
        let map = null;
        let markers = [];
        let currentLocation = null;
        let currentLocationMarker = null;
        let heatmapLayer = null;
        let infoWindow = null;
        let navigationLine = null;
        let isNavigating = false;
        let isPaused = false;
        let currentTransportMode = 'driving';
        let navAnimationFrame = null;
        let navPath = []; // å¯¼èˆªè·¯å¾„åæ ‡æ•°ç»„
        let navCharacterMarker = null; // å¯¼èˆªäººç‰©æ ‡è®°
        let navCurrentIndex = 0; // å½“å‰åŠ¨ç”»ä½ç½®ç´¢å¼•
        let navProgress = 0; // å¯¼èˆªè¿›åº¦ï¼ˆ0-100ï¼‰
        let currentHeatmapRadius = CONFIG.HEATMAP_OPTIONS.radius; // å½“å‰çƒ­åŠ›å›¾åŠå¾„

        // ============ ä¿®å¤ï¼šåœ°å›¾åˆå§‹åŒ– ============
        function initMap() {
            console.log('æ­£åœ¨åˆå§‹åŒ–åœ°å›¾ç³»ç»Ÿ...');

            try {
                // æ£€æŸ¥é«˜å¾·åœ°å›¾APIæ˜¯å¦å¯ç”¨
                if (typeof AMap === 'undefined') {
                    updateStatus('é«˜å¾·åœ°å›¾APIåŠ è½½å¤±è´¥', true);
                    return;
                }

                // åˆå§‹åŒ–åœ°å›¾ - ä¿®å¤Canvasæ€§èƒ½è­¦å‘Š + é€‚é…å«æ˜Ÿå›¾
                map = new AMap.Map('mapContainer', {
                    zoom: CONFIG.DEFAULT_ZOOM,
                    center: CONFIG.DEFAULT_CENTER,
                    viewMode: '2D', // æ”¹ä¸º2Dè§†å›¾ï¼Œæå‡å«æ˜Ÿå›¾å…¼å®¹æ€§
                    mapStyle: 'amap://styles/normal',
                    resizeEnable: true,
                    maxZoom: CONFIG.MAX_ZOOM, // é™åˆ¶æœ€å¤§ç¼©æ”¾çº§åˆ«
                    renderOptions: {
                        willReadFrequently: true  // ä¿®å¤Canvasæ€§èƒ½è­¦å‘Š
                    }
                });

                // åˆå§‹åŠ è½½æ ‡å‡†åœ°å›¾ç“¦ç‰‡ï¼ˆç¡®ä¿é»˜è®¤æ˜¾ç¤ºæ­£å¸¸ï¼‰
                const normalLayer = new AMap.TileLayer({
                    url: 'https://webst0{1,2,3,4}.is.autonavi.com/appmaptile?style=7&x={x}&y={y}&z={z}&key=' + CONFIG.AMAP_KEY,
                    zIndex: 1
                });
                map.add(normalLayer);

                // æ–°å¢ï¼šç›‘å¬åœ°å›¾åŠ è½½é”™è¯¯ï¼ˆå®šä½å«æ˜Ÿå›¾æƒé™é—®é¢˜ï¼‰
                map.on('error', (err) => {
                    console.error('åœ°å›¾åŠ è½½é”™è¯¯:', err);
                    if (err.info.includes('SERVICE_NOT_AVAILABLE')) {
                        updateStatus('å«æ˜Ÿå½±åƒæœåŠ¡æœªå¼€é€šï¼Œå·²è‡ªåŠ¨åˆ‡æ¢è‡³æ ‡å‡†åœ°å›¾', true);
                        switchMapMode('normal');
                    } else if (err.info.includes('INVALID_USER_KEY')) {
                        updateStatus('API Keyæ— æ•ˆï¼Œè¯·æ›´æ¢æ­£ç¡®çš„Webç«¯JS API Key', true);
                    } else if (err.info.includes('OVER_QUERY_LIMIT')) {
                        updateStatus('APIè°ƒç”¨æ¬¡æ•°è¶…é™ï¼Œè¯·ç¨åå†è¯•', true);
                    }
                });

                // ä¿®å¤ï¼šå®‰å…¨çš„æ§ä»¶åŠ è½½
                addMapControlsSafely();

                // åˆ›å»ºä¿¡æ¯çª—å£
                infoWindow = new AMap.InfoWindow({
                    offset: new AMap.Pixel(0, -30),
                    closeWhenClickMap: true
                });

                // ç»‘å®šåœ°å›¾ç‚¹å‡»äº‹ä»¶
                map.on('click', function (e) {
                    setCurrentPosition([e.lnglat.getLng(), e.lnglat.getLat()]);
                });

                // ä¸ä½¿ç”¨æœ¬åœ°é™æ€æ•°æ®ï¼Œç‚¹å‡»â€œæ˜¾ç¤ºå…¨éƒ¨â€ä»é«˜å¾·POIæ£€ç´¢å…¬å•æ•°æ®
                updateStatus('å°±ç»ªï¼šè¯·ç‚¹å‡»â€œæ˜¾ç¤ºå…¨éƒ¨â€ä»é«˜å¾·POIæ£€ç´¢å…¬å•æ•°æ®');

                // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ï¼ˆåˆå§‹å‡ä¸º0ï¼‰
                updateStatistics();

                updateStatus('å…¨å›½å…¬å•ç³»ç»Ÿå·²å¯åŠ¨ï¼Œæ”¯æŒå«æ˜Ÿå½±åƒåˆ‡æ¢å’Œå¢å¼ºçƒ­åŠ›å›¾');
                console.log('åœ°å›¾ç³»ç»Ÿåˆå§‹åŒ–æˆåŠŸï¼');

            } catch (error) {
                console.error('åœ°å›¾åˆå§‹åŒ–å¤±è´¥:', error);
                updateStatus('åœ°å›¾åŠ è½½å¤±è´¥: ' + error.message, true);
            }
        }

        // ============ ä¿®å¤ï¼šå®‰å…¨çš„æ§ä»¶åŠ è½½ ============
        function addMapControlsSafely() {
            // æ·»åŠ æ¯”ä¾‹å°º
            if (window.AMap && AMap.Scale) {
                try {
                    map.addControl(new AMap.Scale({
                        position: 'LB',
                        visible: true
                    }));
                } catch (e) {
                    console.warn('æ¯”ä¾‹å°ºæ§ä»¶åŠ è½½å¤±è´¥:', e.message);
                }
            }

            // ä¿®å¤ToolBaré—®é¢˜
            if (window.AMap && AMap.ToolBar) {
                try {
                    // å…ˆæ£€æŸ¥ç‰ˆæœ¬å…¼å®¹æ€§
                    if (typeof AMap.ToolBar === 'function') {
                        map.addControl(new AMap.ToolBar({
                            position: 'LT',
                            offset: [10, 10]
                        }));
                        console.log('ToolBaræ§ä»¶åŠ è½½æˆåŠŸ');
                    } else {
                        console.warn('ToolBarä¸æ˜¯æ„é€ å‡½æ•°ï¼Œè·³è¿‡');
                    }
                } catch (error) {
                    console.warn('ToolBaråˆå§‹åŒ–å¤±è´¥ï¼Œåˆ›å»ºè‡ªå®šä¹‰å·¥å…·æ ');
                    createCustomToolbar();
                }
            } else {
                console.warn('ToolBaræ§ä»¶ä¸å¯ç”¨ï¼Œåˆ›å»ºè‡ªå®šä¹‰å·¥å…·æ ');
                createCustomToolbar();
            }
        }

        // ============ ä¿®å¤ï¼šè‡ªå®šä¹‰å·¥å…·æ  ============
        function createCustomToolbar() {
            const toolbarDiv = document.createElement('div');
            toolbarDiv.style.cssText = `
                position: absolute;
                top: 20px;
                right: 20px;
                background: white;
                border-radius: 4px;
                box-shadow: 0 2px 6px rgba(0,0,0,0.3);
                padding: 5px;
                z-index: 1000;
                display: flex;
                gap: 5px;
            `;

            toolbarDiv.innerHTML = `
                <button onclick="map.zoomIn()" style="width: 30px; height: 30px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">+</button>
                <button onclick="map.zoomOut()" style="width: 30px; height: 30px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">-</button>
            `;

            document.getElementById('mapContainer').appendChild(toolbarDiv);
        }

        // ============ æ ¸å¿ƒåŠŸèƒ½å®ç° ============

        // 1. åŠ è½½æ‰€æœ‰å…¬å•
        function loadAllToilets() {
            clearMarkers();

            if (!NATIONAL_TOILET_DATA || NATIONAL_TOILET_DATA.length === 0) {
                updateStatus('å½“å‰æ²¡æœ‰å…¬å•æ•°æ®ã€‚è¯·ç‚¹å‡»â€œæ˜¾ç¤ºå…¨éƒ¨â€ä»é«˜å¾·POIæ£€ç´¢å…¬å•æ•°æ®', true);
                updateStatistics();
                return;
            }

            NATIONAL_TOILET_DATA.forEach(toilet => {
                const marker = createToiletMarker(toilet);
                markers.push(marker);
                map.add(marker);
            });

            // è°ƒæ•´åˆ°åˆé€‚è§†é‡æ˜¾ç¤ºå…¨å›½
            map.setZoomAndCenter(CONFIG.DEFAULT_ZOOM, CONFIG.DEFAULT_CENTER);
            updateStatus(`å·²åŠ è½½å…¨å›½ ${NATIONAL_TOILET_DATA.length} ä¸ªå…¬å•æ•°æ®`);
            updateStatistics();
        }

        // 2. åˆ›å»ºå…¬å•æ ‡è®°
        function createToiletMarker(toilet) {
            let color = '#3498db';
            let icon = 'ğŸš»';

            if (toilet.type === 'accessible') {
                color = '#e74c3c';
                icon = 'â™¿';
            } else if (toilet.type === 'mother') {
                color = '#9b59b6';
                icon = 'ğŸ‘¶';
            }

            const marker = new AMap.Marker({
                position: [toilet.lng, toilet.lat],
                title: `${toilet.name} (${toilet.city}) - çƒ­åº¦: ${toilet.popularity}`,
                content: `
                    <div style="background: ${color}; color: white; 
                         width: 36px; height: 36px; border-radius: 50%; 
                         display: flex; align-items: center; justify-content: center;
                         font-size: 18px; font-weight: bold; box-shadow: 0 2px 6px rgba(0,0,0,0.3);
                         border: 2px solid white; cursor: pointer;">
                        ${icon}
                    </div>
                `,
                offset: new AMap.Pixel(-18, -18)
            });

            // ç»‘å®šç‚¹å‡»äº‹ä»¶
            marker.on('click', function () {
                showToiletInfo(toilet, marker.getPosition());
                document.getElementById('selectToilet').value = toilet.id;
            });

            return marker;
        }

        // 3. ä¿®å¤ï¼šåˆ‡æ¢åœ°å›¾æ¨¡å¼ï¼ˆæ ¸å¿ƒä¿®å¤å«æ˜Ÿå›¾æ˜¾ç¤ºï¼Œå¢å¼ºçƒ­åŠ›å›¾ï¼‰
        function switchMapMode(mode) {
            // å…³é”®ï¼šå…ˆç§»é™¤æ‰€æœ‰ç°æœ‰åŸºç¡€å›¾å±‚ï¼ˆé¿å…è¦†ç›–ï¼‰
            const allLayers = map.getLayers();
            allLayers.forEach(layer => {
                // åªä¿ç•™æ§ä»¶/æ ‡è®°å›¾å±‚ï¼Œç§»é™¤åœ°å›¾ç“¦ç‰‡/çƒ­åŠ›å›¾å›¾å±‚
                if (layer instanceof AMap.TileLayer || layer instanceof AMap.HeatMap) {
                    map.remove(layer);
                }
            });

            // éšè—çƒ­åŠ›å›¾å›¾ä¾‹
            document.getElementById('heatmapLegend').style.display = 'none';

            switch (mode) {
                case 'normal':
                    // åŠ è½½æ ‡å‡†åœ°å›¾ï¼ˆçŸ¢é‡å›¾ï¼‰
                    const normalLayer = new AMap.TileLayer({
                        url: 'https://webst0{1,2,3,4}.is.autonavi.com/appmaptile?style=7&x={x}&y={y}&z={z}&key=' + CONFIG.AMAP_KEY,
                        zIndex: 1
                    });
                    map.add(normalLayer);
                    heatmapLayer = null;
                    updateStatus('å·²åˆ‡æ¢è‡³æ ‡å‡†åœ°å›¾');
                    break;

                case 'satellite':
                    try {
                        // æ–¹æ¡ˆ1ï¼šä¼˜å…ˆä½¿ç”¨å®˜æ–¹å«æ˜Ÿå›¾å±‚ï¼ˆéœ€æƒé™ï¼‰
                        const satelliteLayer = new AMap.TileLayer.Satellite({ zIndex: 1 });
                        map.add(satelliteLayer);
                        // å åŠ è·¯ç½‘ï¼ˆé¿å…çº¯å«æ˜Ÿå›¾æ— é“è·¯æ ‡æ³¨ï¼‰
                        const roadNetLayer = new AMap.TileLayer.RoadNet({ zIndex: 2 });
                        map.add(roadNetLayer);
                        updateStatus('å·²åˆ‡æ¢è‡³å«æ˜Ÿå½±åƒï¼ˆå«è·¯ç½‘æ ‡æ³¨ï¼‰');
                    } catch (e) {
                        console.warn('å®˜æ–¹å«æ˜Ÿå›¾å±‚åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨ç“¦ç‰‡ç›´è¿æ¨¡å¼:', e);
                        // æ–¹æ¡ˆ2ï¼šç“¦ç‰‡ç›´è¿æ¨¡å¼ï¼ˆæ— éœ€æƒé™ï¼Œç¨³å®šæ˜¾ç¤ºï¼‰
                        const satelliteTileLayer = new AMap.TileLayer({
                            zIndex: 1,
                            getTileUrl: (x, y, z) => {
                                // å«æ˜Ÿç“¦ç‰‡URLæ¨¡æ¿ï¼ˆstyle=6ä»£è¡¨å«æ˜Ÿå›¾ï¼‰
                                const subdomain = ['1', '2', '3', '4'][Math.floor(Math.random() * 4)];
                                return `https://webst0${subdomain}.is.autonavi.com/appmaptile?style=6&x=${x}&y=${y}&z=${z}&key=${CONFIG.AMAP_KEY}`;
                            }
                        });
                        map.add(satelliteTileLayer);
                        // å åŠ è·¯ç½‘ï¼ˆæ˜¾ç¤ºé“è·¯åç§°ï¼‰
                        const roadLayer = new AMap.TileLayer.RoadNet({ zIndex: 2 });
                        map.add(roadLayer);
                        updateStatus('å·²åˆ‡æ¢è‡³å«æ˜Ÿå½±åƒï¼ˆç¨³å®šç“¦ç‰‡æ¨¡å¼ï¼‰');
                    }
                    heatmapLayer = null;
                    break;

                case 'heatmap':
                    showDarkHeatmap();
                    break;
            }
        }

        // 4. å¢å¼ºï¼šæ˜¾ç¤ºæ·±è‰²çƒ­åŠ›å›¾ï¼ˆæ–°å¢åŠ¨æ€åŠå¾„ã€å›¾ä¾‹æ˜¾ç¤ºï¼‰
        // å¢å¼ºç‰ˆï¼šæ·±è‰²çƒ­åŠ›å›¾åˆå§‹åŒ–ï¼ˆä¿®å¤åŠ è½½å¤±è´¥ï¼‰
        function showDarkHeatmap() {
            // å…ˆç§»é™¤ç°æœ‰çƒ­åŠ›å›¾
            if (heatmapLayer) {
                map.remove(heatmapLayer);
                heatmapLayer = null;
                document.getElementById('heatmapLegend').style.display = 'none';
                updateStatus('å·²å…³é—­çƒ­åŠ›å›¾');
                return;
            }

            // å¼ºåˆ¶æ£€æŸ¥AMapå¯¹è±¡æ˜¯å¦å­˜åœ¨
            if (typeof AMap === 'undefined') {
                updateStatus('é«˜å¾·åœ°å›¾APIæœªåŠ è½½å®Œæˆ', true);
                return;
            }

            // æ–¹æ¡ˆ1ï¼šä½¿ç”¨v2.0å…¼å®¹å†™æ³•åŠ è½½HeatMapæ’ä»¶
            AMap.plugin(['AMap.HeatMap'], function () {
                // å»¶è¿Ÿ500msç¡®ä¿æ’ä»¶å®Œå…¨åŠ è½½
                setTimeout(() => {
                    try {
                        // 1. å…ˆéªŒè¯HeatMapç±»æ˜¯å¦å­˜åœ¨
                        if (typeof AMap.HeatMap !== 'function') {
                            updateStatus('çƒ­åŠ›å›¾æ’ä»¶åŠ è½½å¤±è´¥ï¼šAMap.HeatMapæœªå®šä¹‰', true);
                            // é™çº§æ–¹æ¡ˆï¼šå°è¯•æ—§ç‰ˆç±»å
                            if (typeof AMap.Heatmap === 'function') {
                                updateStatus('å°è¯•ä½¿ç”¨æ—§ç‰ˆçƒ­åŠ›å›¾ç±»å', false);
                                initHeatmap(AMap.Heatmap);
                            }
                            return;
                        }

                        // 2. åˆå§‹åŒ–çƒ­åŠ›å›¾ï¼ˆå…¼å®¹v2.0ï¼‰
                        initHeatmap(AMap.HeatMap);

                    } catch (error) {
                        console.error('çƒ­åŠ›å›¾åˆå§‹åŒ–å¼‚å¸¸:', error);
                        updateStatus(`çƒ­åŠ›å›¾åŠ è½½å¤±è´¥ï¼š${error.message}`, true);
                        // ç»ˆæé™çº§ï¼šæ˜¾ç¤ºé™æ€çƒ­åŠ›å›¾æ ‡è®°
                        showStaticHeatmapMarkers();
                    }
                }, 500);
            });

            // æ ¸å¿ƒåˆå§‹åŒ–é€»è¾‘ï¼ˆæŠ½ç¦»ä¸ºå‡½æ•°ï¼‰
            function initHeatmap(HeatMapClass) {
                // å‡†å¤‡çƒ­åŠ›å›¾æ•°æ®
                const heatmapData = NATIONAL_TOILET_DATA.map(toilet => ({
                    lng: toilet.lng,
                    lat: toilet.lat,
                    count: toilet.popularity || 50 // çƒ­åº¦å€¼ï¼ˆ0-100ï¼‰
                }));

                // åˆ›å»ºçƒ­åŠ›å›¾å®ä¾‹
                heatmapLayer = new HeatMapClass(map, {
                    radius: currentHeatmapRadius,
                    opacity: [0.2, 0.8], // é™ä½é€æ˜åº¦é¿å…é®æŒ¡åœ°å›¾
                    gradient: { // ç®€åŒ–æ¸å˜é…ç½®ï¼ˆé¿å…å…¼å®¹é—®é¢˜ï¼‰
                        0.1: '#3366FF',
                        0.3: '#33CCCC',
                        0.5: '#99CC00',
                        0.7: '#FFCC33',
                        0.9: '#FF3333'
                    },
                    zIndex: 5
                });

                // è®¾ç½®æ•°æ®ï¼ˆå…¼å®¹v1.4å’Œv2.0ï¼‰
                if (heatmapLayer.setData) {
                    heatmapLayer.setData(heatmapData); // v2.0
                } else if (heatmapLayer.setDataSet) {
                    heatmapLayer.setDataSet({ data: heatmapData }); // v1.4
                } else {
                    throw new Error('çƒ­åŠ›å›¾æ— setData/setDataSetæ–¹æ³•');
                }

                // æ˜¾ç¤ºå›¾ä¾‹
                document.getElementById('heatmapLegend').style.display = 'block';
                updateStatus(`å·²æ˜¾ç¤ºçƒ­åŠ›å›¾ - åŠå¾„: ${currentHeatmapRadius}px`);
            }

            // é™çº§æ–¹æ¡ˆï¼šé™æ€çƒ­åŠ›å›¾æ ‡è®°ï¼ˆAPIåŠ è½½å¤±è´¥æ—¶å¤‡ç”¨ï¼‰
            function showStaticHeatmapMarkers() {
                NATIONAL_TOILET_DATA.forEach(toilet => {
                    // æ ¹æ®çƒ­åº¦å€¼è®¾ç½®æ ‡è®°é¢œè‰²
                    let color = '#3366FF';
                    if (toilet.popularity > 60) color = '#33CCCC';
                    if (toilet.popularity > 70) color = '#99CC00';
                    if (toilet.popularity > 80) color = '#FFCC33';
                    if (toilet.popularity > 90) color = '#FF3333';

                    const marker = new AMap.Marker({
                        position: [toilet.lng, toilet.lat],
                        content: `<div style="width: ${toilet.popularity / 5}px; height: ${toilet.popularity / 5}px; 
                             background: ${color}; border-radius: 50%; opacity: 0.7;"></div>`,
                        offset: new AMap.Pixel(-toilet.popularity / 10, -toilet.popularity / 10)
                    });
                    map.add(marker);
                    markers.push(marker);
                });
                updateStatus('çƒ­åŠ›å›¾åŠ è½½å¤±è´¥ï¼Œå·²æ˜¾ç¤ºé™æ€çƒ­åº¦æ ‡è®°', true);
            }
        }
        // æ–°å¢ï¼šè°ƒæ•´çƒ­åŠ›å›¾åŠå¾„ï¼ˆä¿®å¤ï¼šæ–¹æ³•è°ƒç”¨ï¼‰
        function adjustHeatmapRadius(newRadius) {
            if (!heatmapLayer) {
                updateStatus('è¯·å…ˆå¯ç”¨çƒ­åŠ›å›¾', true);
                return;
            }

            currentHeatmapRadius = newRadius;
            // ä¿®å¤ï¼šç›´æ¥ä¿®æ”¹é…ç½®å¹¶é‡æ–°æ¸²æŸ“
            heatmapLayer.setOptions({ radius: newRadius });
            // é‡æ–°è®¾ç½®æ•°æ®è§¦å‘é‡ç»˜
            const heatmapData = NATIONAL_TOILET_DATA.map(toilet => ({
                lng: toilet.lng,
                lat: toilet.lat,
                count: toilet.popularity || 50
            }));
            heatmapLayer.setData({
                data: heatmapData,
                max: 100
            });

            updateStatus(`çƒ­åŠ›å›¾åŠå¾„å·²è°ƒæ•´ä¸º: ${newRadius}px`);
        }

        // 5. è®¾ç½®å½“å‰ä½ç½®
        function setCurrentPosition(position) {
            currentLocation = position;

            document.getElementById('currentPosition').value =
                `${position[0].toFixed(6)}, ${position[1].toFixed(6)}`;

            if (currentLocationMarker) {
                map.remove(currentLocationMarker);
            }

            currentLocationMarker = new AMap.Marker({
                position: position,
                content: `
                    <div style="background: #2ecc71; color: white; 
                         width: 40px; height: 40px; border-radius: 50%; 
                         display: flex; align-items: center; justify-content: center;
                         font-size: 20px; font-weight: bold; box-shadow: 0 3px 10px rgba(0,0,0,0.3);
                         border: 3px solid white;">
                        ğŸ“
                    </div>
                `,
                offset: new AMap.Pixel(-20, -20),
                zIndex: 100 // ç¡®ä¿å½“å‰ä½ç½®æ ‡è®°åœ¨æœ€ä¸Šå±‚
            });

            map.add(currentLocationMarker);
        }

        // 6. è·å–GPSä½ç½®
        function getGPSLocation() {
            if (!navigator.geolocation) {
                updateStatus('æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†å®šä½', true);
                return;
            }

            updateStatus('æ­£åœ¨è·å–å½“å‰ä½ç½®...');

            navigator.geolocation.getCurrentPosition(
                function (position) {
                    const location = [
                        position.coords.longitude,
                        position.coords.latitude
                    ];
                    setCurrentPosition(location);
                    map.setCenter(location);
                    map.setZoom(Math.min(12, CONFIG.MAX_ZOOM)); // é™åˆ¶ç¼©æ”¾çº§åˆ«
                    updateStatus('GPSå®šä½æˆåŠŸ');
                },
                function (error) {
                    updateStatus('å®šä½å¤±è´¥ï¼Œè¯·æ£€æŸ¥å®šä½æƒé™', true);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000
                }
            );
        }

        // 7. æ–°å¢ï¼šåˆ›å»ºå¯¼èˆªäººç‰©æ ‡è®°
        function createNavCharacter(position) {
            if (navCharacterMarker) {
                map.remove(navCharacterMarker);
            }

            // åˆ›å»ºå¸¦DOMå…ƒç´ çš„æ ‡è®°ï¼ˆä¿®å¤ï¼šç¡®ä¿èƒ½è·å–åˆ°å…ƒç´ ï¼‰
            const characterDiv = document.createElement('div');
            characterDiv.className = 'nav-character';

            navCharacterMarker = new AMap.Marker({
                position: position,
                content: characterDiv,
                offset: new AMap.Pixel(-20, -20),
                zIndex: 1000 // ç¡®ä¿äººç‰©åœ¨æœ€ä¸Šå±‚
            });

            map.add(navCharacterMarker);
            return navCharacterMarker;
        }

        // 8. æ–°å¢ï¼šå¯¼èˆªåŠ¨ç”»æ ¸å¿ƒå‡½æ•°ï¼ˆä¿®å¤ï¼šDOMå…ƒç´ è·å–ï¼‰
        function animateNavigation() {
            if (isPaused || !isNavigating || navPath.length <= 1) return;

            // è·å–å½“å‰é€Ÿåº¦ï¼ˆæ ¹æ®äº¤é€šå·¥å…·ç±»å‹ï¼‰
            const speed = CONFIG.ANIMATION_SPEED[currentTransportMode];

            // è·å–å½“å‰ä½ç½®å’Œä¸‹ä¸€ä¸ªç›®æ ‡ç‚¹
            const currentPos = navPath[navCurrentIndex];
            const nextPos = navPath[navCurrentIndex + 1];

            // è®¡ç®—ä¸¤ç‚¹ä¹‹é—´çš„è·ç¦»
            const distance = calculateDistance(currentPos, nextPos);

            // å¦‚æœè·ç¦»å¾ˆè¿‘ï¼Œç›´æ¥è·³åˆ°ä¸‹ä¸€ä¸ªç‚¹
            if (distance < 10) {
                navCurrentIndex++;
                navCharacterMarker.setPosition(nextPos);

                // æ›´æ–°è¿›åº¦
                navProgress = (navCurrentIndex / (navPath.length - 1)) * 100;
                document.getElementById('navProgressBar').style.width = `${navProgress}%`;

                // å¯¼èˆªå®Œæˆ
                if (navCurrentIndex >= navPath.length - 1) {
                    finishNavigation();
                    return;
                }

                // è®¡ç®—äººç‰©æœå‘ï¼ˆé¢å‘ä¸‹ä¸€ä¸ªç‚¹ï¼‰
                const angle = calculateAngle(currentPos, nextPos);
                // ä¿®å¤ï¼šæ­£ç¡®è·å–å¯¼èˆªäººç‰©DOMå…ƒç´ å¹¶è®¾ç½®æ—‹è½¬
                const characterEl = navCharacterMarker.getContent();
                if (characterEl) {
                    characterEl.style.transform = `rotate(${angle}deg)`;
                }

                requestAnimationFrame(animateNavigation);
                return;
            }

            // è®¡ç®—ç§»åŠ¨æ­¥é•¿
            const stepLng = (nextPos[0] - currentPos[0]) / distance * speed;
            const stepLat = (nextPos[1] - currentPos[1]) / distance * speed;

            // æ›´æ–°äººç‰©ä½ç½®
            const newPos = [currentPos[0] + stepLng, currentPos[1] + stepLat];
            navCharacterMarker.setPosition(newPos);

            // æ›´æ–°è·¯å¾„æ•°ç»„ä¸­çš„å½“å‰ä½ç½®ï¼ˆç¡®ä¿åŠ¨ç”»æµç•…ï¼‰
            navPath[navCurrentIndex] = newPos;

            // è®¡ç®—äººç‰©æœå‘
            const angle = calculateAngle(newPos, nextPos);
            // ä¿®å¤ï¼šæ­£ç¡®è·å–å¯¼èˆªäººç‰©DOMå…ƒç´ å¹¶è®¾ç½®æ—‹è½¬
            const characterEl = navCharacterMarker.getContent();
            if (characterEl) {
                characterEl.style.transform = `rotate(${angle}deg)`;
            }

            // ç»§ç»­ä¸‹ä¸€å¸§åŠ¨ç”»
            navAnimationFrame = requestAnimationFrame(animateNavigation);
        }

        // 9. æ–°å¢ï¼šè®¡ç®—ä¸¤ç‚¹ä¹‹é—´çš„è§’åº¦ï¼ˆç”¨äºäººç‰©æœå‘ï¼‰
        function calculateAngle(from, to) {
            const dx = to[0] - from[0];
            const dy = to[1] - from[1];
            let angle = Math.atan2(dy, dx) * 180 / Math.PI;
            return angle + 90; // è°ƒæ•´æœå‘ï¼Œè®©äººç‰©é¢å‘ç§»åŠ¨æ–¹å‘
        }

        // 10. æ–°å¢ï¼šä½¿ç”¨é«˜å¾·APIè·å–çœŸå®é“è·¯è·¯å¾„
        function getRealRoadPath(start, end, callback) {
            AMap.plugin('AMap.Driving', function () {
                const driving = new AMap.Driving({
                    map: map,
                    policy: AMap.DrivingPolicy.LEAST_TIME
                });

                driving.search(
                    new AMap.LngLat(start[0], start[1]),
                    new AMap.LngLat(end[0], end[1]),
                    (status, result) => {
                        if (status === 'complete' && result.routes.length > 0) {
                            const path = [];
                            // æå–æ‰€æœ‰è·¯å¾„ç‚¹
                            result.routes[0].steps.forEach(step => {
                                step.path.forEach(pt => {
                                    path.push([pt.lng, pt.lat]);
                                });
                            });
                            callback(path);
                        } else {
                            // å¦‚æœè·å–ä¸åˆ°çœŸå®è·¯å¾„ï¼Œä½¿ç”¨ç›´çº¿è·¯å¾„å…œåº•
                            callback([start, end]);
                        }
                    }
                );
            });
        }

        // 11. å¼€å§‹å¯¼èˆªï¼ˆæ–°å¢åŠ¨ç”»é€»è¾‘ï¼‰
        function startNavigation() {
            if (!currentLocation) {
                updateStatus('è¯·å…ˆè®¾ç½®å½“å‰ä½ç½®', true);
                return;
            }

            const toiletId = document.getElementById('selectToilet').value;
            if (!toiletId) {
                updateStatus('è¯·é€‰æ‹©ç›®æ ‡å…¬å•', true);
                return;
            }

            const toilet = NATIONAL_TOILET_DATA.find(t => t.id == toiletId);
            if (!toilet) {
                updateStatus('å…¬å•ä¿¡æ¯ä¸å­˜åœ¨', true);
                return;
            }

            isNavigating = true;
            isPaused = false;
            currentTransportMode = document.getElementById('transportMode').value;
            const destination = [toilet.lng, toilet.lat];

            // æ˜¾ç¤ºå¯¼èˆªä¿¡æ¯
            document.getElementById('navInfo').style.display = 'block';
            document.getElementById('navDestination').textContent = toilet.name;
            document.getElementById('navTransport').textContent = getTransportName(currentTransportMode);
            document.getElementById('btnPauseNavigation').style.display = 'block';
            document.getElementById('navProgress').style.display = 'block';
            document.getElementById('navProgressBar').style.width = '0%';

            // è·å–çœŸå®é“è·¯è·¯å¾„
            getRealRoadPath(currentLocation, destination, (path) => {
                navPath = path;
                navCurrentIndex = 0;
                navProgress = 0;

                // ç»˜åˆ¶å¯¼èˆªè·¯çº¿
                drawNavigationRoute(path);

                // åˆ›å»ºå¯¼èˆªäººç‰©
                createNavCharacter(currentLocation);

                // è®¡ç®—è·ç¦»å’Œæ—¶é—´
                const distance = calculateDistance(currentLocation, destination);
                const time = calculateTravelTime(distance, currentTransportMode);
                document.getElementById('navDistance').textContent = formatDistance(distance);
                document.getElementById('navTime').textContent = formatTime(time);

                // å¼€å§‹åŠ¨ç”»
                animateNavigation();

                updateStatus(`å¼€å§‹${getTransportName(currentTransportMode)}å¯¼èˆªåˆ°: ${toilet.name}`);
            });
        }

        // 12. ç»˜åˆ¶å¯¼èˆªè·¯çº¿ï¼ˆæ”¯æŒå¤šè·¯å¾„ç‚¹ï¼‰
        function drawNavigationRoute(path) {
            if (navigationLine) {
                map.remove(navigationLine);
            }

            navigationLine = new AMap.Polyline({
                path: path,
                strokeColor: "#3366FF",
                strokeWeight: 6,
                strokeOpacity: 0.8,
                strokeStyle: "solid",
                zIndex: 10 // ç¡®ä¿è·¯çº¿åœ¨æœ€ä¸Šå±‚
            });

            map.add(navigationLine);
            map.setFitView([navigationLine], { padding: [50, 50, 50, 50] });
        }

        // 13. æ–°å¢ï¼šæš‚åœ/ç»§ç»­å¯¼èˆª
        function togglePauseNavigation() {
            isPaused = !isPaused;
            const btn = document.getElementById('btnPauseNavigation');

            if (isPaused) {
                btn.innerHTML = '<<i>â–¶ï¸</</i> ç»§ç»­å¯¼èˆª';
                updateStatus('å¯¼èˆªå·²æš‚åœ');
                if (navAnimationFrame) {
                    cancelAnimationFrame(navAnimationFrame);
                }
            } else {
                btn.innerHTML = '<<i>â¸ï¸</</i> æš‚åœå¯¼èˆª';
                updateStatus(`ç»§ç»­${getTransportName(currentTransportMode)}å¯¼èˆª`);
                animateNavigation();
            }
        }

        // 14. æ–°å¢ï¼šå®Œæˆå¯¼èˆª
        function finishNavigation() {
            isNavigating = false;
            updateStatus(`å¯¼èˆªå®Œæˆï¼å·²åˆ°è¾¾${document.getElementById('navDestination').textContent}`);

            // æ˜¾ç¤ºåˆ°è¾¾æç¤º
            infoWindow.setContent(`
                <div style="padding: 12px; text-align: center;">
                    <div style="font-size: 18px; color: #27ae60; margin-bottom: 8px;">ğŸ‰ å¯¼èˆªå®Œæˆï¼</div>
                    <div style="color: #555;">å·²åˆ°è¾¾ç›®æ ‡å…¬å•</div>
                </div>
            `);
            infoWindow.open(map, navPath[navPath.length - 1]);

            // æ¸…é™¤åŠ¨ç”»å’Œè¿›åº¦æ¡
            if (navAnimationFrame) {
                cancelAnimationFrame(navAnimationFrame);
            }
            document.getElementById('navProgress').style.display = 'none';
            document.getElementById('btnPauseNavigation').style.display = 'none';
        }

        // 15. æœç´¢åŸå¸‚å…¬å•
        function searchCityToilets() {
            const city = document.getElementById('searchCity').value.trim();
            if (!city) {
                updateStatus('è¯·è¾“å…¥åŸå¸‚åç§°', true);
                return;
            }

            updateStatus(`æ­£åœ¨æœç´¢${city}çš„å…¬å•...`);

            // ç­›é€‰è¯¥åŸå¸‚çš„å…¬å•
            const cityToilets = NATIONAL_TOILET_DATA.filter(toilet =>
                toilet.city.includes(city)
            );

            if (cityToilets.length === 0) {
                updateStatus(`æœªæ‰¾åˆ°${city}çš„å…¬å•æ•°æ®`, true);
                return;
            }

            // æ¸…é™¤æ ‡è®°å¹¶æ˜¾ç¤ºè¯¥åŸå¸‚å…¬å•
            clearMarkers();
            cityToilets.forEach(toilet => {
                const marker = createToiletMarker(toilet);
                markers.push(marker);
                map.add(marker);
            });

            // å¦‚æœå½“å‰æ˜¾ç¤ºçƒ­åŠ›å›¾ï¼Œæ›´æ–°çƒ­åŠ›å›¾æ•°æ®ä¸ºå½“å‰åŸå¸‚
            if (heatmapLayer) {
                const heatmapData = cityToilets.map(toilet => ({
                    lng: toilet.lng,
                    lat: toilet.lat,
                    count: toilet.popularity || 50
                }));
                // ä¿®å¤ï¼šä½¿ç”¨setDataæ›´æ–°çƒ­åŠ›å›¾æ•°æ®
                heatmapLayer.setData({
                    data: heatmapData,
                    max: 100
                });
                updateStatus(`æ‰¾åˆ°${city} ${cityToilets.length} ä¸ªå…¬å•ï¼Œå·²æ›´æ–°çƒ­åŠ›å›¾`);
            } else {
                updateStatus(`æ‰¾åˆ°${city} ${cityToilets.length} ä¸ªå…¬å•`);
            }

            // è°ƒæ•´åœ°å›¾è§†é‡
            const lngs = cityToilets.map(t => t.lng);
            const lats = cityToilets.map(t => t.lat);
            const centerLng = (Math.min(...lngs) + Math.max(...lngs)) / 2;
            const centerLat = (Math.min(...lats) + Math.max(...lats)) / 2;

            map.setCenter([centerLng, centerLat]);
            map.setZoom(Math.min(12, CONFIG.MAX_ZOOM)); // é™åˆ¶ç¼©æ”¾çº§åˆ«
        }

        // ============ ä»é«˜å¾·POIæ£€ç´¢å…¬å•ï¼ˆJSONPï¼‰ ============
        function fetchPOIPageJSONP(page = 1, timeout = 12000) {
            return new Promise((resolve, reject) => {
                const callbackName = 'amap_poi_cb_' + Date.now() + '_' + Math.floor(Math.random() * 10000);
                window[callbackName] = function (data) {
                    try {
                        delete window[callbackName];
                    } catch (e) {}
                    document.body.removeChild(script);
                    resolve(data);
                };

                const script = document.createElement('script');
                script.src = `https://restapi.amap.com/v3/place/text?key=${CONFIG.AMAP_KEY}&keywords=%E5%8E%95%E6%89%AF&city=å…¨å›½&offset=25&page=${page}&output=json&extensions=all&callback=${callbackName}`;
                script.onerror = function (e) {
                    try { delete window[callbackName]; } catch (ex) {}
                    document.body.removeChild(script);
                    reject(new Error('JSONPåŠ è½½å¤±è´¥'));
                };

                document.body.appendChild(script);

                // è¶…æ—¶ä¿æŠ¤
                const to = setTimeout(() => {
                    try { delete window[callbackName]; } catch (e) {}
                    if (document.body.contains(script)) document.body.removeChild(script);
                    reject(new Error('JSONPè¯·æ±‚è¶…æ—¶'));
                }, timeout);

                // resolve will clear timeout
                const origResolve = resolve;
                resolve = function (data) { clearTimeout(to); origResolve(data); };
            });
        }

        async function fetchAllToiletsFromGaode(maxPages = 8) {
            updateStatus('æ­£åœ¨ä»é«˜å¾·æ£€ç´¢å…¬å•æ•°æ®â€¦');
            NATIONAL_TOILET_DATA.length = 0; // æ¸…ç©ºæ—§æ•°æ®
            try {
                for (let page = 1; page <= maxPages; page++) {
                    try {
                        const data = await fetchPOIPageJSONP(page);
                        if (!data || !data.pois || data.pois.length === 0) break;
                        data.pois.forEach((poi, idx) => {
                            const loc = (poi.location && poi.location.split) ? poi.location.split(',') : [];
                            const lng = parseFloat(loc[0]) || 0;
                            const lat = parseFloat(loc[1]) || 0;
                            NATIONAL_TOILET_DATA.push({
                                id: poi.id || (`gaode_${page}_${idx}`),
                                name: poi.name || 'æœªçŸ¥å…¬å•',
                                lng, lat,
                                city: poi.pname || poi.cityname || poi.adname || '',
                                type: 'general',
                                popularity: 70,
                                address: poi.address || ''
                            });
                        });
                        // å¦‚æœæœ¬é¡µä¸åˆ°25æ¡ï¼Œè¯´æ˜æœ€åä¸€é¡µ
                        if (data.pois.length < 25) break;
                        await new Promise(r => setTimeout(r, 200)); // å°å»¶è¿Ÿï¼Œé¿å…è¢«é™æµ
                    } catch (e) {
                        console.warn('ç¬¬' + page + 'é¡µæ‹‰å–å¤±è´¥:', e.message || e);
                        break;
                    }
                }

                if (NATIONAL_TOILET_DATA.length === 0) {
                    updateStatus('æœªèƒ½ä»é«˜å¾·æ£€ç´¢åˆ°å…¬å•æ•°æ®ï¼Œè¯·æ£€æŸ¥Keyæƒé™æˆ–æ‰‹åŠ¨é‡è¯•', true);
                    return 0;
                }

                // å¡«å……ä¸‹æ‹‰å¹¶æ˜¾ç¤º
                populateToiletSelect();
                loadAllToilets();
                updateStatus(`ä»é«˜å¾·æˆåŠŸæ£€ç´¢ ${NATIONAL_TOILET_DATA.length} ä¸ªå…¬å•`);
                return NATIONAL_TOILET_DATA.length;
            } catch (e) {
                updateStatus('ä»é«˜å¾·æ£€ç´¢å…¬å•å¤±è´¥: ' + (e.message || e), true);
                return 0;
            }
        }

        function populateToiletSelect() {
            const toiletSelect = document.getElementById('selectToilet');
            toiletSelect.innerHTML = '<option value="">è¯·é€‰æ‹©ç›®æ ‡å…¬å•</option>';
            NATIONAL_TOILET_DATA.forEach(toilet => {
                const option = document.createElement('option');
                option.value = toilet.id;
                option.textContent = `${toilet.name} (${toilet.city}) - çƒ­åº¦: ${toilet.popularity}`;
                toiletSelect.appendChild(option);
            });
        }

        // ============ å·¥å…·å‡½æ•° ============
        function calculateDistance(point1, point2) {
            const R = 6371000;
            const dLat = (point2[1] - point1[1]) * Math.PI / 180;
            const dLon = (point2[0] - point1[0]) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(point1[1] * Math.PI / 180) * Math.cos(point2[1] * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function calculateTravelTime(distance, transport) {
            let speed = 5; // é»˜è®¤æ­¥è¡Œé€Ÿåº¦ km/h

            switch (transport) {
                case 'walking':
                    speed = 5; // 5 km/h
                    break;
                case 'driving':
                    speed = 40; // 40 km/h
                    break;
                case 'bicycling':
                    speed = 15; // 15 km/h
                    break;
                case 'transit':
                    speed = 20; // 20 km/h
                    break;
            }

            const hours = distance / 1000 / speed;
            return hours * 60; // è¿”å›åˆ†é’Ÿæ•°
        }

        function formatDistance(meters) {
            if (meters < 1000) {
                return `${Math.round(meters)}ç±³`;
            } else {
                return `${(meters / 1000).toFixed(1)}å…¬é‡Œ`;
            }
        }

        function formatTime(minutes) {
            if (minutes < 60) {
                return `${Math.round(minutes)}åˆ†é’Ÿ`;
            } else {
                const hours = Math.floor(minutes / 60);
                const mins = Math.round(minutes % 60);
                return mins > 0 ? `${hours}å°æ—¶${mins}åˆ†é’Ÿ` : `${hours}å°æ—¶`;
            }
        }

        function getTransportName(mode) {
            const names = {
                'walking': 'æ­¥è¡Œ',
                'driving': 'é©¾è½¦',
                'bicycling': 'éª‘è¡Œ',
                'transit': 'å…¬äº¤'
            };
            return names[mode] || mode;
        }

        function showToiletInfo(toilet, position) {
            const content = `
                <div style="padding: 12px; max-width: 250px;">
                    <div style="font-size: 16px; font-weight: bold; color: #2c3e50; margin-bottom: 8px;">
                        ${toilet.name}
                    </div>
                    <div style="color: #7f8c8d; margin-bottom: 4px;">
                        ğŸ“ ${toilet.city}
                    </div>
                    <div style="color: #555; margin-bottom: 4px;">
                        ğŸ”¢ ${toilet.type === 'accessible' ? 'æ— éšœç¢å•æ‰€' :
                    toilet.type === 'mother' ? 'æ¯å©´å®¤' : 'æ™®é€šå…¬å•'}
                    </div>
                    <div style="color: #e67e22; font-weight: 600;">
                        ğŸ”¥ çƒ­åº¦å€¼: ${toilet.popularity}/100
                    </div>
                </div>
            `;

            infoWindow.setContent(content);
            infoWindow.open(map, position);
        }

        function clearMarkers() {
            markers.forEach(marker => map.remove(marker));
            markers = [];
        }

        function updateStatistics() {
            const total = NATIONAL_TOILET_DATA.length;
            const general = NATIONAL_TOILET_DATA.filter(t => t.type === 'general').length;
            const accessible = NATIONAL_TOILET_DATA.filter(t => t.type === 'accessible').length;
            const mother = NATIONAL_TOILET_DATA.filter(t => t.type === 'mother').length;
            const displayed = markers.length;

            document.getElementById('totalToilets').textContent = total;
            document.getElementById('displayedToilets').textContent = displayed;
            document.getElementById('generalCount').textContent = general;
            document.getElementById('accessibleCount').textContent = accessible;
            document.getElementById('motherCount').textContent = mother;
        }

        function updateStatus(message, isError = false) {
            const statusDiv = document.getElementById('systemStatus');
            statusDiv.textContent = message;
            statusDiv.style.borderLeftColor = isError ? '#e74c3c' : '#3498db';
        }

        // ============ äº‹ä»¶ç»‘å®š ============
        function bindEvents() {
            // åœ°å›¾æ¨¡å¼
            document.getElementById('btnNormalMap').onclick = () => switchMapMode('normal');
            document.getElementById('btnSatellite').onclick = () => switchMapMode('satellite');
            document.getElementById('btnDarkHeatmap').onclick = () => switchMapMode('heatmap');

            // çƒ­åŠ›å›¾æ§åˆ¶ - æ–°å¢
            document.getElementById('btnHeatmapSmall').onclick = () => adjustHeatmapRadius(CONFIG.HEATMAP_OPTIONS.minRadius);
            document.getElementById('btnHeatmapMedium').onclick = () => adjustHeatmapRadius(CONFIG.HEATMAP_OPTIONS.radius);
            document.getElementById('btnHeatmapLarge').onclick = () => adjustHeatmapRadius(CONFIG.HEATMAP_OPTIONS.maxRadius);

            // ä½ç½®åŠŸèƒ½
            document.getElementById('btnSearchCity').onclick = searchCityToilets;
            document.getElementById('btnGetLocation').onclick = getGPSLocation;

            // å…¬å•æ§åˆ¶
            document.getElementById('btnShowAll').onclick = () => fetchAllToiletsFromGaode(8);
            document.getElementById('btnClearAll').onclick = () => {
                clearMarkers();
                if (navigationLine) {
                    map.remove(navigationLine);
                    navigationLine = null;
                }
                // æ¸…é™¤çƒ­åŠ›å›¾
                if (heatmapLayer) {
                    map.remove(heatmapLayer);
                    heatmapLayer = null;
                    document.getElementById('heatmapLegend').style.display = 'none';
                }
                // æ¸…é™¤å¯¼èˆªåŠ¨ç”»
                if (isNavigating) {
                    stopNavigation();
                }
                document.getElementById('navInfo').style.display = 'none';
                document.getElementById('navProgress').style.display = 'none';
                document.getElementById('btnPauseNavigation').style.display = 'none';
                isNavigating = false;
                updateStatus('å·²æ¸…ç©ºæ‰€æœ‰æ˜¾ç¤ºï¼ˆåŒ…æ‹¬çƒ­åŠ›å›¾ï¼‰');
                updateStatistics();
            };

            // å¯¼èˆªåŠŸèƒ½
            document.getElementById('btnStartNavigation').onclick = startNavigation;
            document.getElementById('btnPauseNavigation').onclick = togglePauseNavigation;
            document.getElementById('btnStopNav').onclick = stopNavigation;

            // åˆå§‹åŒ–å…¬å•ä¸‹æ‹‰ä¸ºç©ºï¼ˆé€šè¿‡é«˜å¾·å¡«å……ï¼‰
            const toiletSelect = document.getElementById('selectToilet');
            toiletSelect.innerHTML = '<option value="">è¯·é€‰æ‹©ç›®æ ‡å…¬å•</option>';
        }

        // æ–°å¢ï¼šåœæ­¢å¯¼èˆª
        function stopNavigation() {
            isNavigating = false;
            isPaused = false;
            if (navAnimationFrame) {
                cancelAnimationFrame(navAnimationFrame);
            }
            if (navCharacterMarker) {
                map.remove(navCharacterMarker);
                navCharacterMarker = null;
            }
            if (navigationLine) {
                map.remove(navigationLine);
                navigationLine = null;
            }
            document.getElementById('navInfo').style.display = 'none';
            document.getElementById('navProgress').style.display = 'none';
            document.getElementById('btnPauseNavigation').style.display = 'none';
            navPath = [];
            navCurrentIndex = 0;
            updateStatus('å¯¼èˆªå·²ç»“æŸ');
        }

        // ============ ä¿®å¤ï¼šç³»ç»Ÿåˆå§‹åŒ–ï¼ˆç¡®ä¿å®¹å™¨æ¸²æŸ“ï¼‰ ============
        window.onload = function () {
            const mapContainer = document.getElementById('mapContainer');
            // æ ¡éªŒå®¹å™¨å°ºå¯¸æ˜¯å¦æ­£å¸¸ï¼Œå¼ºåˆ¶ä¿®å¤
            if (mapContainer.offsetHeight === 0 || mapContainer.offsetWidth === 0) {
                mapContainer.style.width = '100%';
                mapContainer.style.height = 'calc(100vh - 60px)';
                updateStatus('å®¹å™¨å°ºå¯¸å¼‚å¸¸ï¼Œå·²å¼ºåˆ¶ä¿®å¤');
            }

            if (typeof AMap !== 'undefined') {
                initMap();
                bindEvents();
                // åˆå§‹åŒ–åè§¦å‘ä¸€æ¬¡é‡ç»˜ï¼Œç¡®ä¿åœ°å›¾æ¸²æŸ“å®Œæ•´
                setTimeout(() => map.resize(), 500);
                updateStatus('å…¨å›½å…¬å•ç³»ç»Ÿå·²å°±ç»ªï¼ˆå¢å¼ºçƒ­åŠ›å›¾ç‰ˆï¼‰');
            } else {
                updateStatus('é«˜å¾·åœ°å›¾APIåŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', true);
                // å°è¯•é‡è¯•åŠ è½½
                setTimeout(() => location.reload(), 3000);
            }
        };
    </script>
</body>

</html>