<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨å›½å…¬å•æ™ºèƒ½å¯¼èˆªç³»ç»Ÿ (è¿›é˜¶ç‰ˆ)</title>

    <script type="text/javascript">
        window._AMapSecurityConfig = {
            securityJsCode: "99e3954b4b466ebbbe24118338ef6c91",
        };
    </script>

    <script
        src="https://webapi.amap.com/maps?v=2.0&key=3da096629cc77da916196115d45f9d63&plugin=AMap.ToolBar,AMap.Scale,AMap.HeatMap,AMap.Driving,AMap.Walking,AMap.Riding,AMap.PlaceSearch,AMap.Geolocation,AMap.MoveAnimation"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft YaHei", sans-serif;
        }

        body,
        html {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .system-header {
            height: 60px;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 1000;
        }

        .system-title {
            font-size: 20px;
            font-weight: bold;
            color: #2c3e50;
            display: flex;
            align-items: center;
        }

        .system-title i {
            margin-right: 10px;
            font-size: 24px;
            color: #3498db;
        }

        .system-version {
            font-size: 14px;
            color: #7f8c8d;
            background: #f8f9fa;
            padding: 5px 15px;
            border-radius: 20px;
        }

        #mapContainer {
            width: 100%;
            height: calc(100vh - 60px);
            position: relative;
        }

        .left-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 320px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
            z-index: 100;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            max-height: 90vh;
            overflow-y: auto;
        }

        .right-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 300px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
            z-index: 100;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
        }

        .panel-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .panel-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .section-title {
            font-size: 16px;
            color: #2c3e50;
            margin-bottom: 15px;
            font-weight: 600;
            display: flex;
            align-items: center;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-label {
            display: block;
            font-size: 13px;
            color: #3498db;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .input-field,
        .select-field {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e0e6ed;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
            background: #f8fafc;
        }

        .clickable-input {
            cursor: pointer;
            background-color: #eef2f7;
        }

        .clickable-input:hover {
            border-color: #3498db;
            background-color: #fff;
        }

        .btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 10px 0;
        }

        .heatmap-controls {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            margin-top: 10px;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .btn-heatmap {
            background: linear-gradient(135deg, #e67e22, #d35400);
            color: white;
            font-size: 13px;
            padding: 8px 5px;
        }

        .status-panel {
            margin-top: 15px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            font-size: 13px;
            color: #2c3e50;
        }

        .navigation-info {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .nav-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .nav-value {
            font-weight: 600;
            color: #2c3e50;
        }

        .nav-distance {
            color: #e74c3c;
            font-size: 18px;
            font-weight: bold;
        }

        .nav-time {
            color: #3498db;
            font-size: 16px;
            font-weight: bold;
        }

        .heatmap-legend {
            position: absolute;
            bottom: 80px;
            left: 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            padding: 10px 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 100;
            display: none;
        }

        /* WMS overlay controls and overlay styling */
        .wms-controls .input-label { font-size:13px; color:#3498db; margin-bottom:5px; font-weight:500; }
        .wms-controls .input-field { padding:8px 10px; border-radius:6px; font-size:13px; }
        .wms-overlay { position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:50; }
        .wms-overlay img { width:100%; height:100%; display:block; }

        .legend-gradient {
            width: 200px;
            height: 20px;
            background: linear-gradient(to right, rgba(128, 0, 128, 0.7), rgba(255, 0, 0, 0.8), rgba(255, 165, 0, 0.9), rgba(255, 255, 0, 1), rgba(255, 255, 255, 1));
            border-radius: 4px;
            margin-bottom: 5px;
        }

        .legend-labels {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #7f8c8d;
        }

        @media (max-width: 1200px) {
            .right-panel {
                display: none;
            }

            .left-panel {
                width: 95%;
                left: 2.5%;
            }
        }
    </style>
</head>

<body>
    <div class="system-header">
        <div class="system-title"><i>ğŸš½</i>å…¨å›½å…¬å•æ™ºèƒ½å¯¼èˆªç³»ç»Ÿ</div>
        <div class="system-version">v3.2 - è¿›é˜¶ç‰ˆ</div>
    </div>

    <div id="mapContainer"></div>

    <div class="heatmap-legend" id="heatmapLegend">
        <div class="legend-title">å…¬å•çƒ­åº¦åˆ†å¸ƒ</div>
        <div class="legend-gradient"></div>
        <div class="legend-labels"><span>ä½</span><span>ä¸­</span><span>é«˜</span></div>
    </div>

    <div class="left-panel">
        <div class="panel-section">
            <div class="section-title"><i>ğŸ—ºï¸</i>åœ°å›¾æ¨¡å¼</div>
            <div class="btn-group">
                <button class="btn btn-primary" id="btnNormalMap"><i>ğŸŒ</i>æ ‡å‡†åœ°å›¾</button>
                <button class="btn btn-secondary" id="btnSatellite"><i>ğŸ›°ï¸</i>å«æ˜Ÿå½±åƒ</button>
                <button class="btn btn-warning" id="btnDarkHeatmap"><i>ğŸ”¥</i>æ·±è‰²çƒ­åŠ›å›¾</button>
            </div>
            <div class="heatmap-controls">
                <button class="btn btn-heatmap" id="btnHeatmapSmall"><i>ğŸ”</i>å°åŠå¾„</button>
                <button class="btn btn-heatmap" id="btnHeatmapMedium"><i>ğŸ”</i>ä¸­åŠå¾„</button>
                <button class="btn btn-heatmap" id="btnHeatmapLarge"><i>ğŸ”</i>å¤§åŠå¾„</button>
            </div>
        </div>

        <div class="panel-section">
            <div class="section-title"><i>ğŸ“</i>ä½ç½®æœç´¢</div>
            <div class="input-group">
                <label class="input-label">æœç´¢åŸå¸‚æˆ–åŒºåŸŸ</label>
                <input type="text" class="input-field" id="searchCity" placeholder="è¾“å…¥åŸå¸‚åç§°ï¼Œå¦‚ï¼šåŒ—äº¬" value="åŒ—äº¬å¸‚">
            </div>
            <button class="btn btn-primary" id="btnSearchCity"
                style="width: 100%; margin-bottom: 10px;"><i>ğŸ”</i>æœç´¢åŒºåŸŸå…¬å•</button>
        </div>

        <div class="panel-section">
            <div class="section-title"><i>ğŸš½</i>å…¬å•æ˜¾ç¤º</div>
            <div class="btn-group">
                <button class="btn btn-primary" id="btnShowAll"><i>ğŸ </i>æœç´¢é™„è¿‘/æ˜¾ç¤ºå…¨éƒ¨</button>
                <button class="btn btn-danger" id="btnClearAll"><i>ğŸ—‘ï¸</i>æ¸…ç©ºæ˜¾ç¤º</button>
            </div>
        </div>

        <div class="panel-section">
            <div class="section-title"><i>ğŸ›°ï¸</i>WMS å›¾å±‚ï¼ˆQGIS Cloudï¼‰</div>
            <div class="input-group wms-controls">
                <label class="input-label">WMS åŸºç¡€ URL</label>
                <input type="text" class="input-field" id="wmsBase" value="https://wms.qgiscloud.com/smilejxl/fx/" />
            </div>
            <div class="input-group wms-controls">
                <label class="input-label">å›¾å±‚å LAYERS</label>
                <select class="select-field" id="wmsLayerSelect">
                    <option value="fx">fxï¼ˆé»˜è®¤ï¼‰</option>
                    <option value="ä¸­å›½çœçº¿">ä¸­å›½çœçº¿</option>
                    <option value="ä¸­å›½çœ">ä¸­å›½çœ</option>
                    <option value="__other__">å…¶ä»–â€¦</option>
                </select>
                <input type="text" class="input-field" id="wmsLayerName" value="fx" style="margin-top:8px; display:none;" placeholder="è¾“å…¥è‡ªå®šä¹‰å›¾å±‚åï¼Œæ¯”å¦‚ï¼šlayer_name" />
            </div>
            <div class="input-group wms-controls">
                <label class="input-label">ä¸é€æ˜åº¦</label>
                <input type="range" id="wmsOpacity" min="0" max="1" step="0.05" value="0.8" style="width:100%;" />
            </div>
            <div class="input-group wms-controls">
                <label class="input-label"><input type="checkbox" id="wmsUseProxy" style="margin-right:8px;">ä½¿ç”¨ä»£ç†ï¼ˆè§£å†³ CORS é—®é¢˜ï¼‰</label>
                <div style="font-size:12px; color:#7f8c8d;">å‹¾é€‰åä¼šé€šè¿‡å…¬å…± proxy å°è¯•åŠ è½½ WMSï¼ˆå¯èƒ½å—é™ï¼‰ã€‚</div>
            </div>
            <div class="btn-group" style="margin-top:8px;">
                <button class="btn btn-primary" id="btnToggleWMS"><i>ğŸŒ</i>åˆ‡æ¢ WMS å›¾å±‚</button>
                <button class="btn btn-secondary" id="btnRefreshWMS"><i>ğŸ”„</i>åˆ·æ–° WMS</button>
            </div>
        </div>

        <div class="status-panel" id="systemStatus">ç³»ç»Ÿåˆå§‹åŒ–ä¸­...</div>

        <div class="status-panel" style="margin-top:10px;">
            <div>å½“å‰æ˜¾ç¤ºå…¬å•: <strong id="displayedToilets">0</strong></div>
        </div>
    </div>

    <div class="right-panel">
        <div class="panel-section">
            <div class="section-title"><i>ğŸ§­</i>å¯¼èˆªè®¾ç½®</div>
            <div class="input-group">
                <label class="input-label">å½“å‰ä½ç½® (å®šä½å¤±è´¥è¯·ç‚¹å‡»é€‰ç‚¹)</label>
                <input type="text" class="input-field clickable-input" id="currentPosition"
                    placeholder="ğŸ–±ï¸ ç‚¹å‡»æ­¤å¤„ï¼Œæ‰‹åŠ¨åœ¨åœ°å›¾é€‰ç‚¹" readonly title="å®šä½å¤±è´¥æ—¶ï¼Œç‚¹å‡»æ­¤å¤„æ‰‹åŠ¨åœ¨åœ°å›¾ä¸Šé€‰æ‹©ä½ç½®">
            </div>
            <div class="input-group">
                <label class="input-label">ç›®æ ‡å…¬å•</label>
                <select class="select-field" id="selectToilet">
                    <option value="">è¯·å…ˆæœç´¢å…¬å•</option>
                </select>
            </div>
            <div class="input-group">
                <label class="input-label">äº¤é€šå·¥å…·</label>
                <select class="select-field" id="transportMode">
                    <option value="Walking">æ­¥è¡Œ</option>
                    <option value="Driving" selected>é©¾è½¦</option>
                    <option value="Riding">éª‘è¡Œ</option>
                </select>
            </div>
            <div class="input-group">
                <label class="input-label"><input type="checkbox" id="showCongestion" style="margin-right:8px;">æ˜¾ç¤ºé“è·¯æ‹¥å µ</label>
                <div style="font-size:12px; color:#7f8c8d;">å‹¾é€‰åï¼Œæ˜¾ç¤ºå¯¼èˆªè·¯çº¿ã€‚</div>
            </div>
            <button class="btn btn-success" id="btnStartNavigation" style="width: 100%;"><i>ğŸš€</i>å¼€å§‹å¯¼èˆª</button>
        </div>

        <div class="navigation-info" id="navInfo" style="display: none;">
            <div class="nav-item"><span>ç›®çš„åœ°ï¼š</span><span class="nav-value" id="navDestination">-</span></div>
            <div class="nav-item"><span>è·ç¦»ï¼š</span><span class="nav-distance" id="navDistance">-</span></div>
            <div class="nav-item"><span>é¢„è®¡æ—¶é—´ï¼š</span><span class="nav-time" id="navTime">-</span></div>
            <div id="navSteps" class="nav-steps" style="margin-top:10px; max-height:180px; overflow:auto; font-size:13px; display:none;"></div>
            <button class="btn btn-danger" id="btnStopNav" style="width: 100%; margin-top: 10px;"><i>â¹ï¸</i>ç»“æŸå¯¼èˆª</button>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        const GOOGLE_API_KEY = 'YOUR_GOOGLE_API_KEY_HERE'; // æ›¿æ¢ä¸ºä½ çš„ Google API Keyï¼›ç•™é»˜è®¤å°†å›é€€åˆ°é«˜å¾·å¯¼èˆª
        const WMS_BASE = 'https://wms.qgiscloud.com/smilejxl/fx/'; // QGIS Cloud WMS åŸºç¡€ URLï¼ˆå¯è¦†ç›–ï¼‰
        let map = null;
        let placeSearch = null;
        let currentMarkers = [];
        let heatmapLayer = null;
        let infoWindow = null;
        // WMS overlay state
        let wmsOverlayEl = null;
        let wmsImgEl = null;
        let wmsEnabled = false;
        let _wmsPrevBlobUrl = null;
        const _wmsProxies = [
            'https://images.weserv.nl/?url=', // image proxy: expects url without protocol
            'https://thingproxy.freeboard.io/fetch/',
            'https://api.allorigins.win/raw?url='
        ];

        // å¯¼èˆªä¸å®šä½ç›¸å…³
        let navPathLine = null;
        let navMarker = null;
        let navStartMarker = null;
        let navEndMarker = null;
        let navStepMarkers = [];
        let currentPos = null;
        let selectedToilet = null;
        let currentLocationMarker = null;
        let isSelectingStart = false;

        window.onload = function () {
            initMap();
        };

        function initMap() {
            try {
                map = new AMap.Map('mapContainer', {
                    zoom: 14,
                    center: [116.397428, 39.90923],
                    viewMode: '3D',
                    resizeEnable: true
                });

                if (AMap.ToolBar) map.addControl(new AMap.ToolBar());
                if (AMap.Scale) map.addControl(new AMap.Scale());

                infoWindow = new AMap.InfoWindow({ offset: new AMap.Pixel(0, -30) });

                AMap.plugin(["AMap.PlaceSearch", "AMap.Geolocation"], function () {
                    placeSearch = new AMap.PlaceSearch({
                        type: 'å…¬å…±å•æ‰€',
                        pageSize: 50,
                        pageIndex: 1,
                        extensions: 'base'
                    });
                    getGPSLocation();
                });

                bindEvents();
                updateStatus('åœ°å›¾åŠ è½½æˆåŠŸ');

            } catch (e) {
                console.error(e);
                updateStatus('åœ°å›¾åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æ£€æŸ¥API Key', true);
            }
        }

        // ============ å…³é”®åŠŸèƒ½ï¼šæ‰‹åŠ¨é€‰ç‚¹ & åœ°å›¾ç‚¹å‡» ============
        function bindEvents() {
            // 1. ç‚¹å‡»â€œå½“å‰ä½ç½®â€è¾“å…¥æ¡† -> æ¿€æ´»é€‰ç‚¹æ¨¡å¼
            document.getElementById('currentPosition').onclick = function () {
                isSelectingStart = true;
                map.setDefaultCursor('crosshair'); // é¼ æ ‡å˜æˆåå­—å‡†æ˜Ÿ
                this.value = "è¯·åœ¨åœ°å›¾ä¸Šç‚¹å‡»ä½ç½®...";
                updateStatus('è¯·åœ¨åœ°å›¾ä¸Šç‚¹å‡»ä»»æ„ä½ç½®ä½œä¸ºæ‚¨çš„èµ·ç‚¹', false);
            };

            // 2. åœ°å›¾ç‚¹å‡»äº‹ä»¶
            map.on('click', function (e) {
                if (isSelectingStart) {
                    // å¦‚æœå¤„äºé€‰èµ·ç‚¹æ¨¡å¼
                    setMyCurrentLocation([e.lnglat.lng, e.lnglat.lat]);
                    isSelectingStart = false;
                    map.setDefaultCursor('default');
                    updateStatus('å½“å‰ä½ç½®å·²æ‰‹åŠ¨æ›´æ–°');
                }
            });

            // æŒ‰é’®äº‹ä»¶
            document.getElementById('btnSearchCity').onclick = searchCityToilets;
            document.getElementById('btnShowAll').onclick = searchNearby;
            document.getElementById('btnStartNavigation').onclick = startNavigation;
            document.getElementById('btnStopNav').onclick = stopNavigation;
            document.getElementById('btnClearAll').onclick = () => { clearMarkers(); stopNavigation(); };
            document.getElementById('btnNormalMap').onclick = () => { map.remove(map.getLayers()); map.add(new AMap.TileLayer()); };
            document.getElementById('btnSatellite').onclick = () => { map.add(new AMap.TileLayer.Satellite()); map.add(new AMap.TileLayer.RoadNet()); };
            document.getElementById('btnDarkHeatmap').onclick = showDarkHeatmap;
            // WMS controls (guarded)
            const btnToggleWMS = document.getElementById('btnToggleWMS'); if (btnToggleWMS) btnToggleWMS.onclick = toggleWMS;
            const btnRefreshWMS = document.getElementById('btnRefreshWMS'); if (btnRefreshWMS) btnRefreshWMS.onclick = updateWMSOverlay;
            const wmsLayerSelect = document.getElementById('wmsLayerSelect');
            const wmsLayerEl = document.getElementById('wmsLayerName');
            if (wmsLayerSelect) {
                wmsLayerSelect.onchange = function() {
                    if (this.value === '__other__') {
                        if (wmsLayerEl) wmsLayerEl.style.display = 'block';
                    } else {
                        if (wmsLayerEl) wmsLayerEl.style.display = 'none';
                        updateWMSOverlay();
                    }
                };
            }
            if (wmsLayerEl) wmsLayerEl.onchange = updateWMSOverlay;
            const wmsOpacityEl = document.getElementById('wmsOpacity'); if (wmsOpacityEl) wmsOpacityEl.oninput = function() { if (wmsImgEl) wmsImgEl.style.opacity = this.value; };

            // Ensure WMS refreshes when map stops moving or after operations
            map.on('moveend', function(){ if (wmsEnabled) updateWMSOverlay(); });
            map.on('complete', function(){ if (wmsEnabled) updateWMSOverlay(); });

            // ä¸‹æ‹‰æ¡†è”åŠ¨é€»è¾‘ (Changeäº‹ä»¶)
            const selectToiletEl = document.getElementById('selectToilet');
            if (selectToiletEl) selectToiletEl.onchange = function () {
                const idx = this.value;
                if (idx !== "") {
                    // é€šè¿‡ç´¢å¼•æ‰¾åˆ°Markerï¼Œå¹¶è§¦å‘ç‚¹å‡»äº‹ä»¶ï¼Œå®ç°è”åŠ¨
                    const marker = currentMarkers[idx];
                    if (marker) {
                        // ä½¿ç”¨æ›´å®‰å…¨çš„è§¦å‘å™¨ï¼Œé¿å… AMap.event æœªå®šä¹‰æ—¶æŠ¥é”™
                        triggerMarkerClick(marker);
                    }
                }
            };
        }

        function setMyCurrentLocation(position) {
            currentPos = position;
            document.getElementById('currentPosition').value = position[0].toFixed(6) + ', ' + position[1].toFixed(6);
            if (currentLocationMarker) map.remove(currentLocationMarker);
            currentLocationMarker = new AMap.Marker({
                position: position,
                map: map,
                content: `<div style="background: #2ecc71; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: bold; box-shadow: 0 3px 10px rgba(0,0,0,0.3); border: 3px solid white;">ğŸ“</div>`,
                offset: new AMap.Pixel(-20, -20),
                zIndex: 999
            });
            map.setCenter(position);
        }

        // ============ æœç´¢é€»è¾‘ ============
        function searchNearby() {
            if (!placeSearch) return;
            const center = map.getCenter();
            updateStatus('æ­£åœ¨æœç´¢å‘¨è¾¹å…¬å•...');
            placeSearch.searchNearBy('', center, 5000, function (status, result) {
                handleSearchResult(status, result);
            });
        }

        function searchCityToilets() {
            const city = document.getElementById('searchCity').value.trim();
            if (!city) { updateStatus('è¯·è¾“å…¥åŸå¸‚åç§°', true); return; }
            updateStatus(`æ­£åœ¨æœç´¢ ${city} çš„å…¬å•...`);
            placeSearch.setCity(city);
            placeSearch.search('', function (status, result) {
                handleSearchResult(status, result);
            });
        }

        function handleSearchResult(status, result) {
            clearMarkers();
            if (status === 'complete' && result.info === 'OK') {
                const pois = result.poiList.pois;
                updateStatus(`æ‰¾åˆ° ${pois.length} ä¸ªå…¬å•`);
                document.getElementById('displayedToilets').innerText = pois.length;

                const select = document.getElementById('selectToilet');
                select.innerHTML = '<option value="">è¯·é€‰æ‹©ç›®æ ‡å…¬å•</option>';

                pois.forEach((poi, index) => {
                    const marker = new AMap.Marker({
                        position: poi.location,
                        map: map,
                        title: poi.name,
                        icon: new AMap.Icon({
                            size: new AMap.Size(32, 32),
                            image: 'https://a.amap.com/jsapi_demos/static/demo-center/icons/poi-marker-default.png',
                            imageSize: new AMap.Size(32, 32)
                        })
                    });

                    // ç‚¹å‡» Marker çš„é€»è¾‘
                    marker.on('click', () => {
                        selectToilet(poi);

                        // ã€è”åŠ¨æ ¸å¿ƒã€‘åŒæ—¶æ›´æ–°ä¸‹æ‹‰æ¡†é€‰ä¸­çŠ¶æ€
                        select.value = index;

                        infoWindow.setContent(`<div style="padding:5px"><b>${poi.name}</b><br>${poi.address}</div>`);
                        infoWindow.open(map, poi.location);

                        // å¹³æ»‘ç§»åŠ¨è§†é‡åˆ°é€‰ä¸­çš„å•æ‰€
                        map.panTo(poi.location);
                    });

                    currentMarkers.push(marker);

                    const option = document.createElement('option');
                    option.value = index;
                    option.text = poi.name;
                    select.appendChild(option);
                });
                map.setFitView(currentMarkers);
                if (heatmapLayer) updateHeatmapData(pois);
            } else {
                updateStatus('æœªæœç´¢åˆ°ç»“æœ', true);
            }
        }

        function selectToilet(poi) {
            selectedToilet = poi;
            updateStatus(`å·²é€‰ä¸­ç›®çš„åœ°: ${poi.name}`);
        }

        // ============ å¯¼èˆªé€»è¾‘ ============
        // Google Polyline è§£ç å™¨ï¼ˆè¿”å› [lng, lat] æ•°ç»„ï¼‰
        function decodeGooglePolyline(str) {
            let index = 0, lat = 0, lng = 0, coordinates = [];
            while (index < str.length) {
                let b, shift = 0, result = 0;
                do {
                    b = str.charCodeAt(index++) - 63;
                    result |= (b & 0x1f) << shift;
                    shift += 5;
                } while (b >= 0x20);
                const dlat = ((result & 1) ? ~(result >> 1) : (result >> 1));
                lat += dlat;

                shift = 0;
                result = 0;
                do {
                    b = str.charCodeAt(index++) - 63;
                    result |= (b & 0x1f) << shift;
                    shift += 5;
                } while (b >= 0x20);
                const dlng = ((result & 1) ? ~(result >> 1) : (result >> 1));
                lng += dlng;

                coordinates.push([lng / 1e5, lat / 1e5]);
            }
            return coordinates;
        }

        function useAMapPlanner(mode, dest) {
            AMap.plugin(["AMap." + mode], function () {
                let planner;
                if (mode === 'Driving') planner = new AMap.Driving({ policy: AMap.DrivingPolicy.LEAST_TIME });
                else if (mode === 'Walking') planner = new AMap.Walking();
                else planner = new AMap.Riding();

                planner.search(new AMap.LngLat(currentPos[0], currentPos[1]), dest, function (status, result) {
                    if (status === 'complete') {
                        if (result.routes && result.routes.length) {
                            drawRoute(result.routes[0]);
                        }
                    } else {
                        updateStatus('è·¯å¾„è§„åˆ’å¤±è´¥ï¼Œå¯èƒ½è·ç¦»è¿‡è¿œæˆ–æ— è·¯', true);
                    }
                });
            });
        }

        // é€šç”¨ drawRouteï¼ˆä¾› AMap Planner ä½¿ç”¨ï¼‰ â€” å¢å¼ºç‰ˆï¼šé«˜äº®è·¯å¾„ã€èµ·ç»ˆç‚¹ä¸é€æ­¥æŒ‡å¼•
        function drawRoute(route) {
            // build path
            let pathArr = [];
            route.steps.forEach(step => { pathArr.push(...step.path); });

            // clear previous
            if (navPathLine) map.remove(navPathLine);
            if (navMarker) { try { navMarker.stopMove(); } catch(e){} map.remove(navMarker); navMarker = null; }
            if (navStartMarker) map.remove(navStartMarker); navStartMarker = null;
            if (navEndMarker) map.remove(navEndMarker); navEndMarker = null;
            if (navStepMarkers && navStepMarkers.length) { navStepMarkers.forEach(m => map.remove(m)); navStepMarkers = []; }

            // draw polyline
            navPathLine = new AMap.Polyline({
                map: map,
                path: pathArr,
                strokeColor: "#ff5722",
                strokeOpacity: 0.95,
                strokeWeight: 6,
                strokeStyle: 'solid'
            });

            // add start & end markers
            if (pathArr.length) {
                const start = pathArr[0];
                const end = pathArr[pathArr.length - 1];
                navStartMarker = new AMap.Marker({ map: map, position: start, content: `<div style="background:#2ecc71;color:#fff;border-radius:50%;width:30px;height:30px;display:flex;align-items:center;justify-content:center;font-weight:bold;">èµ·</div>`, offset: new AMap.Pixel(-15,-15), zIndex: 999 });
                navEndMarker = new AMap.Marker({ map: map, position: end, content: `<div style="background:#e74c3c;color:#fff;border-radius:50%;width:30px;height:30px;display:flex;align-items:center;justify-content:center;font-weight:bold;">ç»ˆ</div>`, offset: new AMap.Pixel(-15,-15), zIndex: 999 });
            }

            // populate step list and create small markers for each step
            const navStepsEl = document.getElementById('navSteps');
            if (navStepsEl) {
                navStepsEl.innerHTML = '';
                const ol = document.createElement('ol');
                ol.style.paddingLeft = '18px';
                route.steps.forEach((s, i) => {
                    const instr = s.instruction || s.action || ('ç¬¬' + (i+1) + 'æ­¥');
                    const li = document.createElement('li');
                    li.style.marginBottom = '6px';
                    const distText = s.distance ? (s.distance + 'm') : '';
                    li.innerHTML = `${instr} <span style="color:#888;font-size:12px">${distText}</span>`;
                    li.onclick = () => { if (s.path && s.path.length) map.setCenter(s.path[0]); };
                    ol.appendChild(li);

                    // step marker at first coord of step
                    if (s.path && s.path.length) {
                        const p = s.path[0];
                        const mk = new AMap.Marker({ map: map, position: p, content: `<div style="width:18px;height:18px;border-radius:9px;background:#3498db;opacity:0.9;border:2px solid white;"></div>`, offset: new AMap.Pixel(-9,-9), zIndex: 990 });
                        mk.on('click', () => { infoWindow.setContent(`<div style="padding:6px">${instr}<br>${distText}</div>`); infoWindow.open(map, p); });
                        navStepMarkers.push(mk);
                    }
                });
                navStepsEl.appendChild(ol);
                navStepsEl.style.display = 'block';
            }

            // set destination texts
            const dist = route.distance > 1000 ? (route.distance / 1000).toFixed(1) + 'km' : route.distance + 'm';
            const time = Math.ceil(route.time / 60) + 'åˆ†é’Ÿ';
            document.getElementById('navDestination').innerText = selectedToilet ? selectedToilet.name : '-';
            document.getElementById('navDistance').innerText = dist;
            document.getElementById('navTime').innerText = time;

            // animate moving marker
            const speed = document.getElementById('transportMode').value === 'Driving' ? 500 : 80;
            if (pathArr.length) {
                navMarker = new AMap.Marker({ map: map, position: pathArr[0], icon: new AMap.Icon({ size: new AMap.Size(26,26), image: "https://webapi.amap.com/images/car.png", imageSize: new AMap.Size(26,26) }), offset: new AMap.Pixel(-13,-13) });
                navMarker.moveAlong(pathArr, { speed: speed, autoRotation: true });
            }

            // fit view
            const fitItems = [navPathLine];
            if (currentLocationMarker) fitItems.push(currentLocationMarker);
            if (navStartMarker) fitItems.push(navStartMarker);
            if (navEndMarker) fitItems.push(navEndMarker);
            map.setFitView(fitItems);

            updateStatus('å¯¼èˆªæ¨¡æ‹Ÿå¼€å§‹...');
        }

        // å®‰å…¨è§¦å‘ Marker ç‚¹å‡»çš„ helperï¼ˆå…¼å®¹å¤šä¸ªåœ°å›¾å®ç°ï¼‰
        function triggerMarkerClick(marker) {
            try {
                if (!marker) return;
                if (typeof marker === 'object') {
                    if (window.AMap && AMap.event && typeof AMap.event.trigger === 'function') {
                        AMap.event.trigger(marker, 'click');
                        return;
                    }
                    if (typeof marker.emit === 'function') { marker.emit('click'); return; }
                    if (typeof marker.fireEvent === 'function') { marker.fireEvent('click'); return; }
                    // æœ€åå°è¯•è°ƒç”¨ marker çš„ click å›è°ƒï¼ˆè‹¥è®¾ç½®äº† _eventsï¼‰
                    if (marker._events && marker._events.click && typeof marker._events.click.forEach === 'function') {
                        marker._events.click.forEach(fn => { try { fn(); } catch (e) { /* ignore */ } });
                    }
                }
            } catch (err) {
                console.warn('triggerMarkerClick failed', err);
            }
        }

        function startNavigation() {
            if (!currentPos) { alert('è¯·å…ˆè®¾ç½®å½“å‰ä½ç½®ï¼ˆç‚¹å‡»è¾“å…¥æ¡†æ‰‹åŠ¨é€‰ç‚¹ï¼‰'); return; }
            if (!selectedToilet) { alert('è¯·å…ˆåœ¨åœ°å›¾ä¸Šé€‰æ‹©ä¸€ä¸ªå…¬å•'); return; }

            const mode = document.getElementById('transportMode').value;
            const dest = selectedToilet.location;

            updateStatus(`æ­£åœ¨è§„åˆ’ ${mode} è·¯çº¿...`);
            document.getElementById('navInfo').style.display = 'block';
            const navStepsEl = document.getElementById('navSteps');
            navStepsEl.style.display = 'none';
            navStepsEl.innerHTML = '';

            if (navPathLine) map.remove(navPathLine);
            if (navMarker) { navMarker.stopMove(); map.remove(navMarker); }

            if (GOOGLE_API_KEY && GOOGLE_API_KEY !== 'YOUR_GOOGLE_API_KEY_HERE') {
                const origin = `${currentPos[1]},${currentPos[0]}`; // lat,lng
                const destination = `${dest.lat},${dest.lng}`;
                const modeMap = { Driving: 'driving', Walking: 'walking', Riding: 'bicycling' };
                const modeParam = modeMap[mode] || 'driving';
                const url = encodeURI(`https://maps.googleapis.com/maps/api/directions/json?origin=${origin}&destination=${destination}&mode=${modeParam}&key=${GOOGLE_API_KEY}`);

                fetch(url).then(res => res.json()).then(data => {
                    if (data.status === 'OK' && data.routes && data.routes.length) {
                        const route = data.routes[0];
                        const overview = route.overview_polyline && route.overview_polyline.points;
                        const pathArr = overview ? decodeGooglePolyline(overview) : [];

                        navPathLine = new AMap.Polyline({
                            map: map,
                            path: pathArr,
                            strokeColor: "#28F",
                            strokeOpacity: 0.8,
                            strokeWeight: 6
                        });
                        map.setFitView([navPathLine, currentLocationMarker]);

                        const leg = route.legs[0];
                        const dist = leg.distance.value > 1000 ? (leg.distance.value / 1000).toFixed(1) + 'km' : leg.distance.value + 'm';
                        const time = Math.ceil(leg.duration.value / 60) + 'åˆ†é’Ÿ';
                        document.getElementById('navDestination').innerText = selectedToilet.name;
                        document.getElementById('navDistance').innerText = dist;
                        document.getElementById('navTime').innerText = time;

                        let list = '<ol style="padding-left:18px; margin:6px 0;">';
                        // clear previous step markers
                        if (navStepMarkers && navStepMarkers.length) { navStepMarkers.forEach(m=>map.remove(m)); navStepMarkers = []; }
                        if (navStartMarker) map.remove(navStartMarker); navStartMarker = null;
                        if (navEndMarker) map.remove(navEndMarker); navEndMarker = null;

                        leg.steps.forEach((s, idx) => {
                            const text = s.html_instructions.replace(/<[^>]+>/g, '');
                            list += `<li style="margin-bottom:6px; cursor:pointer;" onclick="map.setCenter(new AMap.LngLat(${s.start_location.lng}, ${s.start_location.lat}))">${text} <span style="color:#888; font-size:12px;">(${s.distance.text}, ${s.duration.text})</span></li>`;

                            // add a small marker at start_location
                            const mk = new AMap.Marker({ map: map, position: [s.start_location.lng, s.start_location.lat], content: `<div style="width:16px;height:16px;border-radius:8px;background:#3498db;border:2px solid white;"></div>`, offset: new AMap.Pixel(-8,-8) });
                            mk.on('click', ()=>{ infoWindow.setContent(`<div style="padding:6px">${text}<br>${s.distance.text}, ${s.duration.text}</div>`); infoWindow.open(map, [s.start_location.lng, s.start_location.lat]); });
                            navStepMarkers.push(mk);
                        });
                        list += '</ol>';
                        navStepsEl.innerHTML = list;
                        navStepsEl.style.display = 'block';

                        // start & end markers
                        if (pathArr.length) {
                            const start = pathArr[0];
                            const end = pathArr[pathArr.length-1];
                            navStartMarker = new AMap.Marker({ map: map, position: start, content: `<div style="background:#2ecc71;color:#fff;border-radius:50%;width:30px;height:30px;display:flex;align-items:center;justify-content:center;font-weight:bold;">èµ·</div>`, offset: new AMap.Pixel(-15,-15) });
                            navEndMarker = new AMap.Marker({ map: map, position: end, content: `<div style="background:#e74c3c;color:#fff;border-radius:50%;width:30px;height:30px;display:flex;align-items:center;justify-content:center;font-weight:bold;">ç»ˆ</div>`, offset: new AMap.Pixel(-15,-15) });
                        }

                        const speed = document.getElementById('transportMode').value === 'Driving' ? 500 : 80;
                        if (pathArr.length) {
                            navMarker = new AMap.Marker({
                                map: map,
                                position: pathArr[0],
                                icon: new AMap.Icon({
                                    size: new AMap.Size(26, 26),
                                    image: "https://webapi.amap.com/images/car.png",
                                    imageSize: new AMap.Size(26, 26),
                                }),
                                offset: new AMap.Pixel(-13, -13),
                            });

                            navMarker.moveAlong(pathArr, {
                                speed: speed,
                                autoRotation: true,
                            });
                        }

                        // fit view
                        const fitItems = [navPathLine];
                        if (currentLocationMarker) fitItems.push(currentLocationMarker);
                        if (navStartMarker) fitItems.push(navStartMarker);
                        if (navEndMarker) fitItems.push(navEndMarker);
                        map.setFitView(fitItems);

                        updateStatus('å¯¼èˆªè§„åˆ’å®Œæˆï¼ˆGoogle Directionsï¼‰');
                    } else {
                        updateStatus('Google è·¯çº¿è§„åˆ’å¤±è´¥ï¼Œå›é€€åˆ°é«˜å¾·è§„åˆ’', true);
                        useAMapPlanner(mode, dest);
                    }
                }).catch(err => {
                    console.error(err);
                    updateStatus('è¯·æ±‚ Google Directions å‡ºé”™ï¼Œå›é€€åˆ°é«˜å¾·è§„åˆ’', true);
                    useAMapPlanner(mode, dest);
                });
            } else {
                useAMapPlanner(mode, dest);
            }
        }

        function stopNavigation() {
            if (navMarker) navMarker.stopMove();
            if (navPathLine) map.remove(navPathLine);
            if (navMarker) map.remove(navMarker);
            document.getElementById('navInfo').style.display = 'none';
            const navStepsEl = document.getElementById('navSteps');
            if (navStepsEl) { navStepsEl.innerHTML = ''; navStepsEl.style.display = 'none'; }
            updateStatus('å¯¼èˆªç»“æŸ');
        }

        // ============ WMS Overlay Functions ============
        function createWMSOverlay() {
            if (wmsOverlayEl) return;
            const container = document.getElementById('mapContainer');
            wmsOverlayEl = document.createElement('div');
            wmsOverlayEl.className = 'wms-overlay';
            wmsImgEl = document.createElement('img');
            wmsImgEl.alt = 'WMS Overlay';
            wmsImgEl.style.opacity = document.getElementById('wmsOpacity') ? document.getElementById('wmsOpacity').value : 0.8;
            wmsImgEl.onerror = function () { updateStatus('WMS åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ CORS æˆ– URL', true); };
            wmsOverlayEl.appendChild(wmsImgEl);
            container.appendChild(wmsOverlayEl);
            updateWMSOverlay();
            window.addEventListener('resize', updateWMSOverlay);
        }

        function removeWMSOverlay() {
            if (!wmsOverlayEl) return;
            wmsOverlayEl.remove();
            wmsOverlayEl = null;
            wmsImgEl = null;
            window.removeEventListener('resize', updateWMSOverlay);
        }

        async function _loadImageByUrl(url) {
            return new Promise((resolve, reject) => {
                if (!wmsImgEl) return reject(new Error('no img element'));
                const onLoad = function() { cleanup(); resolve(true); };
                const onError = function() { cleanup(); reject(new Error('img load error')); };
                function cleanup(){ wmsImgEl.onload = null; wmsImgEl.onerror = null; }
                wmsImgEl.onload = onLoad;
                wmsImgEl.onerror = onError;
                wmsImgEl.src = url + '&_t=' + Date.now();
            });
        }

        async function _setImageViaProxy(originalUrl) {
            // Try setting the <img> src to each proxy endpoint (many public proxies allow image GETs)
            for (let p of _wmsProxies) {
                let proxyUrl;
                try {
                    if (p.includes('weserv.nl')) {
                        // images.weserv expects the URL without protocol
                        const cleaned = originalUrl.replace(/^https?:\/\//, '');
                        proxyUrl = `${p}${encodeURIComponent(cleaned)}`;
                    } else {
                        proxyUrl = p + encodeURIComponent(originalUrl);
                    }
                } catch (err) {
                    console.warn('proxy url build failed', p, err);
                    continue;
                }

                // capture the current img reference so cleanup doesn't touch a removed element
                const img = wmsImgEl;
                if (!img) { console.warn('no wmsImgEl present, abort proxy attempt'); continue; }

                const ok = await new Promise((resolve) => {
                    let done = false;
                    const timer = setTimeout(() => { if (!done) { done = true; cleanup(); resolve(false); } }, 8000);

                    function cleanup(){ try { if (img) { img.onload = null; img.onerror = null; } } catch(e){} clearTimeout(timer); }

                    const onload = function() { if (!done) { done = true; cleanup(); resolve(true); } };
                    const onerror = function() { if (!done) { done = true; cleanup(); resolve(false); } };

                    try {
                        // If img was removed in the meantime, abort
                        if (!img) { cleanup(); resolve(false); return; }
                        img.onload = onload;
                        img.onerror = onerror;
                        img.src = proxyUrl + '&_t=' + Date.now();
                    } catch (err) { cleanup(); resolve(false); }
                });

                if (ok) {
                    try { if (wmsImgEl) wmsImgEl.style.opacity = document.getElementById('wmsOpacity') ? document.getElementById('wmsOpacity').value : 0.8; } catch(e){}
                    updateStatus(`WMS é€šè¿‡ä»£ç†åŠ è½½æˆåŠŸï¼š ${p}`);
                    return true;
                }
                console.warn('proxy image attempt failed for', proxyUrl || p);
            }
            return false;
        }

        async function updateWMSOverlay() {
            try {
                if (!wmsOverlayEl || !wmsImgEl || !map) return;
                const base = (document.getElementById('wmsBase') && document.getElementById('wmsBase').value) || WMS_BASE;
                // æ”¯æŒä¸‹æ‹‰é€‰æ‹©ä¼˜å…ˆï¼Œé€‰ä¸­â€œå…¶ä»–â€æ—¶ä½¿ç”¨è‡ªå®šä¹‰è¾“å…¥æ¡†
                const sel = document.getElementById('wmsLayerSelect');
                const custom = document.getElementById('wmsLayerName');
                let layers = 'fx';
                if (sel && sel.value && sel.value !== '__other__') layers = sel.value;
                else if (custom && custom.value) layers = custom.value;
                const container = document.getElementById('mapContainer');
                const width = Math.max(256, Math.round(container.clientWidth));
                const height = Math.max(256, Math.round(container.clientHeight));
                const bounds = map.getBounds();
                if (!bounds) return;
                const sw = bounds.getSouthWest();
                const ne = bounds.getNorthEast();
                const wmsUseProxy = document.getElementById('wmsUseProxy') && document.getElementById('wmsUseProxy').checked;

                function lonLatToMercator(lng, lat) {
                    const x = lng * 20037508.34 / 180;
                    let y = Math.log(Math.tan((90 + lat) * Math.PI / 360)) / (Math.PI / 180);
                    y = y * 20037508.34 / 180;
                    return { x: x, y: y };
                }

                const swM = lonLatToMercator(sw.lng, sw.lat);
                const neM = lonLatToMercator(ne.lng, ne.lat);
                const bbox3857 = `${swM.x},${swM.y},${neM.x},${neM.y}`;
                const bbox4326 = `${sw.lng},${sw.lat},${ne.lng},${ne.lat}`;

                const params3857 = `SERVICE=WMS&REQUEST=GetMap&VERSION=1.3.0&LAYERS=${encodeURIComponent(layers)}&STYLES=&FORMAT=image/png&TRANSPARENT=true&WIDTH=${width}&HEIGHT=${height}&CRS=EPSG:3857&BBOX=${bbox3857}`;
                const url3857 = `${base}?${params3857}`;
                const url4326 = `${base}?SERVICE=WMS&REQUEST=GetMap&VERSION=1.1.1&LAYERS=${encodeURIComponent(layers)}&STYLES=&FORMAT=image/png&TRANSPARENT=true&WIDTH=${width}&HEIGHT=${height}&SRS=EPSG:4326&BBOX=${bbox4326}`;

                // revoke previous blob url
                if (_wmsPrevBlobUrl) { try { URL.revokeObjectURL(_wmsPrevBlobUrl); } catch(e){} _wmsPrevBlobUrl = null; }

                // Try direct 3857 then 4326, unless proxy requested; then try proxy versions
                if (!wmsUseProxy) {
                    try {
                        await _loadImageByUrl(url3857);
                        updateStatus('WMS 3857 å·²åŠ è½½');
                        return;
                    } catch (e1) {
                        console.warn('WMS 3857 åŠ è½½å¤±è´¥ï¼Œå°è¯• 4326 å›é€€', e1);
                        try { await _loadImageByUrl(url4326); updateStatus('WMS 4326 å·²åŠ è½½'); return; } catch (e2) { console.warn('WMS 4326 åŠ è½½å¤±è´¥', e2); }
                        // fallthrough to proxy attempts
                    }
                }

                // Proxy attempts by setting image src through proxies (avoids fetch CORS issues)
                try {
                    const ok3857 = await _setImageViaProxy(url3857);
                    if (ok3857) return;
                } catch (px1) { console.warn('proxy 3857 fail', px1); }
                try {
                    const ok4326 = await _setImageViaProxy(url4326);
                    if (ok4326) return;
                } catch (px2) { console.warn('proxy 4326 fail', px2); }

                updateStatus('WMS åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ CORS æˆ– URLï¼ˆä»£ç†ä¹Ÿå¤±è´¥ï¼‰', true);
            } catch (err) {
                console.error(err);
                updateStatus('WMS æ›´æ–°å¤±è´¥', true);
            }
        }

        function toggleWMS() {
            if (!wmsEnabled) {
                createWMSOverlay();
                wmsEnabled = true;
                updateStatus('WMS å›¾å±‚å·²å¯ç”¨');
            } else {
                removeWMSOverlay();
                wmsEnabled = false;
                updateStatus('WMS å›¾å±‚å·²ç¦ç”¨');
            }
        }

        // ============ è¾…åŠ©åŠŸèƒ½ ============
        function getGPSLocation() {
            updateStatus('æ­£åœ¨è‡ªåŠ¨å®šä½...');
            AMap.plugin('AMap.Geolocation', function () {
                var geolocation = new AMap.Geolocation({
                    enableHighAccuracy: true,
                    timeout: 5000,
                    zoomToAccuracy: true,
                    buttonPosition: 'RB'
                });

                geolocation.getCurrentPosition(function (status, result) {
                    if (status == 'complete') {
                        setMyCurrentLocation([result.position.lng, result.position.lat]);
                        updateStatus('å®šä½æˆåŠŸ');
                        searchNearby();
                    } else {
                        updateStatus('è‡ªåŠ¨å®šä½å¤±è´¥ï¼Œè¯·ç‚¹å‡»å³ä¸Šè§’è¾“å…¥æ¡†æ‰‹åŠ¨é€‰ç‚¹', true);
                    }
                });
            });
        }

        function showDarkHeatmap() {
            if (heatmapLayer) { map.remove(heatmapLayer); heatmapLayer = null; return; }
            if (currentMarkers.length === 0) { alert('è¯·å…ˆæœç´¢å…¬å•æ•°æ®'); return; }

            AMap.plugin(["AMap.HeatMap"], function () {
                heatmapLayer = new AMap.HeatMap(map, {
                    radius: 25,
                    opacity: [0, 0.8]
                });
                const points = currentMarkers.map(m => ({
                    lng: m.getPosition().lng,
                    lat: m.getPosition().lat,
                    count: Math.floor(Math.random() * 100)
                }));
                heatmapLayer.setDataSet({ data: points, max: 100 });
                document.getElementById('heatmapLegend').style.display = 'block';
            });
        }

        function updateHeatmapData(pois) {
            const points = pois.map(p => ({
                lng: p.location.lng,
                lat: p.location.lat,
                count: Math.floor(Math.random() * 100)
            }));
            heatmapLayer.setDataSet({ data: points, max: 100 });
        }

        function clearMarkers() {
            map.remove(currentMarkers);
            currentMarkers = [];
        }

        function updateStatus(msg, isError = false) {
            const el = document.getElementById('systemStatus');
            el.innerText = msg;
            el.style.borderLeftColor = isError ? '#e74c3c' : '#3498db';
            console.log(msg);
        }
    </script>
</body>


</html>

